{% extends 'base.html' %}
{% load static %}

{% block links %}
<link rel="stylesheet" href="{% static 'css/cards/cards_home.css' %}">
<style>
    .select2-container .select2-dropdown {
        z-index: 1055 !important; /* Certifique-se de que esteja acima do modal */
    }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8); /* Fundo semitransparente */
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1; /* Garantir que fique acima do conteúdo do card */
    }

    .spinner {
        border: 6px solid #f3f3f3; /* Fundo claro */
        border-top: 6px solid #3498db; /* Cor principal do spinner */
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .position-relative {
        position: relative; /* Garante que o overlay se posicione corretamente */
    }

    .required {
        color: red;  /* Tornando o asterisco vermelho */
    }

</style>
{% endblock %}

{% block content %}

<input type="hidden" name="tipo-usuario" id="tipo-usuario" value="{{request.user.tipo_acesso}}">

<div class="mb-3">
    <div class="mb-3">
        <!-- Botão para mostrar/ocultar filtros -->
        <h2 class="fs-5">
            <a class="btn btn-link" data-bs-toggle="collapse" href="#collapseFiltros" role="button" aria-expanded="false" aria-controls="collapseFiltros">
                Filtros
            </a>
        </h2>
    
        <!-- Collapse para o Formulário de Filtros -->
        <div class="collapse" id="collapseFiltros">
            <form method="GET" class="row g-3" id="filter-form">
                {% if request.user.tipo_acesso == 'administrador' or request.user.tipo_acesso == 'operador' %}
                <div class="col-md-3">
                    <label for="ordem" class="form-label">#OS</label>
                    <input type="text" class="form-control" id="ordem" name="ordem" value="{{ ordem|default_if_none:'' }}" placeholder="Número da ordem">
                </div>
                <div class="col-md-3">
                    <label for="solicitante" class="form-label">Solicitante</label>
                    <input type="text" class="form-control" id="solicitante" name="solicitante" value="{{ solicitante|default_if_none:'' }}" placeholder="Nome do Solicitante">
                </div>
                <div class="col-md-3">
                    <label for="setor" class="form-label">Setor</label>
                    <select class="form-select" id="setor" name="setor">
                        <option value="">Todos</option>
                        {% for setor in setores %}
                        <option value="{{ setor.id }}" {% if setor_id == setor.id|stringformat:"s" %}selected{% endif %}>{{ setor.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                <div class="col-md-3">
                    <label for="ultimo_status" class="form-label">Status</label>
                    <select class="form-select" id="ultimo_status" name="ultimo_status">
                        <option value="">Todos</option>
                        <option value="em_espera">Em espera</option>
                        {% for status in status_choices %}
                        <option value="{{ status.0 }}" >{{ status.1 }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% if request.user.tipo_acesso == 'administrador' or request.user.tipo_acesso == 'operador' %}
                <div class="col-md-3">
                    <label for="maq_parada" class="form-label">Máquina Parada</label>
                    <select class="form-select" id="maq_parada" name="maq_parada">
                        <option value="">Todos</option>
                        <option value="sim" {% if maq_parada == 'sim' %}selected{% endif %}>Sim</option>
                        <option value="nao" {% if maq_parada == 'nao' %}selected{% endif %}>Não</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="data_abertura" class="form-label">Data de Abertura</label>
                    <input type="date" class="form-control" id="data_abertura" name="data_abertura" value="{{ data_abertura|default_if_none:'' }}">
                </div>
                <div class="col-md-3">
                    <label for="responsavel" class="form-label">Responsável</label>
                    <select class="form-select" id="responsavel" name="responsavel">
                        <option value="">Todos</option>
                        {% for operador in operadores %}
                            <option value="{{operador.pk}}">{{operador.nome}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="planejada" name="planejada" value="1"
                            {% if planejada == '1' %}checked{% endif %}>
                        <label class="form-check-label" for="planejada">Mostrar Apenas Planejadas</label>
                    </div>
                
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="atrasada" name="atrasada" value="1"
                            {% if atrasada == '1' %}checked{% endif %}>
                        <label class="form-check-label" for="atrasada">Mostrar Apenas Atrasadas</label>
                    </div>
                </div>
                {% endif %}
                <div class="col-12 text-end">
                    <button id="btnFilter" type="submit" class="btn btn-primary">Filtrar</button>
                    <button id="btnLimparFiltro" type="submit" class="btn btn-secondary">Limpar Filtros</button>
                </div>
            </form>
        </div>
    </div>

    <div>
        <div class="row row-cols-1 row-cols-md-4">
            <div class="col">
                <div class="card custom-card custom-border-primary">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div>
                                <p class="mb-0 text-secondary">Aguardando programação</p>
                                <h4 class="my-1 text-primary">{{ aguardando_primeiro_atendimento_card }}</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card custom-card custom-border-warning">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div>
                                <p class="mb-0 text-secondary">Em espera</p>
                                <h4 class="my-1 text-warning">{{ quantidade_em_aberto }}</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card custom-card custom-border-info">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div>
                                <p class="mb-0 text-secondary">Em andamento</p>
                                <h4 class="my-1 text-info">{{ quantidade_em_execucao }}</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card custom-card custom-border-secondary">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div>
                                <p class="mb-0 text-secondary">Aguardando material</p>
                                <h4 class="my-1 text-secondary">{{ aguardando_material }}</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card custom-card custom-border-success">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div>
                                <p class="mb-0 text-secondary">Finalizada</p>
                                <h4 class="my-1 text-success">{{ quantidade_finalizada }}</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card custom-card custom-border-danger">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div>
                                <p class="mb-0 text-secondary">Atrasada</p>
                                <h4 class="my-1 text-danger">{{ quantidade_atrasada }}</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row my-4 d-flex justify-content-around">
        <!-- Aguardando primeiro atendimento -->
        {% if request.user.tipo_acesso == 'administrador' or request.user.tipo_acesso == 'solicitante' %}
        <div class="col-sm-6 mb-3">
            <div class="card">
                <div class="card-header" id="headingAguardandoPrimeiroAtendimento">
                    <h5 class="mb-0">
                        <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAguardandoPrimeiroAtendimento" aria-expanded="true" aria-controls="collapseAguardandoPrimeiroAtendimento">
                            A programar
                        </button>
                    </h5>
                </div>
                <div id="collapseAguardandoPrimeiroAtendimento" class="collapse show" aria-labelledby="headingAguardandoPrimeiroAtendimento">
                    <div class="card-body" style="min-height: 500px; max-height: 500px; overflow-y: auto;">
                        <div class="row" id="aguardando-primeiro-atendimento-container">
                            <p>Carregando...</p>
                        </div>
                        <div class="row justify-content-center my-4">
                            <div class="col-auto">
                                <div class="col-auto" id="container-button-aguardando">
                                    <button style="display: none;" class="btn btn-primary" id="loadMoreAguardandoPrimeiroAtendimento" data-next-page="">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Solicitações -->
        <div class="col-sm-6">
            <div class="card">
                <div class="card-header" id="headingSolicitacoes">
                    <h5 class="mb-0">
                        <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolicitacoes" aria-expanded="true" aria-controls="collapseSolicitacoes">
                            Programadas
                        </button>
                    </h5>
                </div>
                <div id="collapseSolicitacoes" class="collapse show" aria-labelledby="headingSolicitacoes">
                    <div class="card-body" style="min-height: 500px; max-height: 500px; overflow-y: auto;">
                        <div class="row" id="solicitacoes-container">
                            <p>Carregando...</p>
                        </div>
                        <div class="row justify-content-center my-4">
                            <div class="col-auto">
                                <button style="display: none;" class="btn btn-primary" id="loadMoreSolicitacoes" data-next-page="">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>
        {% else %}
        <!-- Solicitações -->
        <div class="col-sm-12">
            <div class="card">
                <div class="card-header" id="headingSolicitacoes">
                    <h5 class="mb-0">
                        <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolicitacoes" aria-expanded="true" aria-controls="collapseSolicitacoes">
                            Programadas
                        </button>
                    </h5>
                </div>
                <div id="collapseSolicitacoes" class="collapse show" aria-labelledby="headingSolicitacoes">
                    <div class="card-body" style="min-height: 500px; max-height: 500px; overflow-y: auto;">
                        <div class="row" id="solicitacoes-container">
                            <p>Carregando...</p>
                        </div>
                        <div class="row justify-content-center my-4">
                            <div class="col-auto">
                                <button style="display: none;" class="btn btn-primary" id="loadMoreSolicitacoes" data-next-page="">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        {% endif %}
    </div>
    <!-- Máquinas paradas -->
    {% if request.user.tipo_acesso == 'administrador' %}
    <div class="row my-4">
        <div class="col-sm-12">
            <div class="card mb-3">
                <div class="card-header" id="headingMaquinasParadas">
                    <h5 class="mb-0">
                        Máquinas paradas
                    </h5>
                </div>
                <div class="card-body" style="min-height: 500px; max-height: 500px; overflow-y: auto;">
                    <div class="row" id="maquinas-paradas-container">
                        <p>Carregando...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

</div>

<script>
    function updateSelectElement(selectElementId, options, labelCallback) {
            var selectElement = document.getElementById(selectElementId);

            if (!selectElement) return;

            // Limpa as opções atuais do select
            selectElement.innerHTML = '';

            // Adiciona a opção padrão
            var defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.text = 'Selecione...';
            selectElement.appendChild(defaultOption);


            // Adiciona novas opções baseadas nos dados retornados
            options.forEach(function(optionData) {
                var option = document.createElement('option');
                option.value = optionData.id;  // Use `id` como valor da opção
                option.text = labelCallback(optionData);  // Usa o callback para definir o texto exibido
                selectElement.appendChild(option);
            });
        }

        function updateSelectElement2(selectElementId, options, labelCallback) {
            var selectElement = document.getElementById(selectElementId);

            if (!selectElement) return;

            // Limpa as opções atuais do select
            selectElement.innerHTML = '';

            // Adiciona a opção padrão
            var defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.text = 'Selecione...';
            selectElement.appendChild(defaultOption);

            // Adiciona novas opções baseadas nos dados retornados
            options.forEach(function(optionData) {
                var option = document.createElement('option');
                option.value = optionData.pk;  // O campo `pk` é o ID único do objeto
                option.text = labelCallback(optionData);  // Usa o callback para definir o texto exibido
                selectElement.appendChild(option);
            });
        }

    document.addEventListener("DOMContentLoaded", function() {      

        var filterForm = document.getElementById('filter-form');

        filterForm.addEventListener('submit', function(e) {
            e.preventDefault();

            // Identifica qual botão foi clicado
            const clickedButtonId = e.submitter.id;
            
            if (clickedButtonId === 'btnLimparFiltro') {
                // Lógica para o botão 'Limpar Filtros'
                filterForm.reset(); // Limpa todos os campos do formulário
            }

            // Lógica para o botão 'Filtrar'
            var formData = new FormData(filterForm);
            var params = new URLSearchParams(formData).toString();

            // Chama a função fetchSolicitacoes passando os parâmetros
            fetchSolicitacoes(
                "solicitacoes/",                  // URL base
                "solicitacoes-container",         // ID do container onde os dados serão inseridos
                "loadMoreSolicitacoes",           // ID do botão de 'load more'
                params,                           // Parâmetros do filtro
                [
                    attachReprogramarOrdemEventListeners,
                    attachExecutarOrdemEventListeners,
                    mudancaStatusFinalizada,
                    attachStatusReenviarWpp,
                    attachModalEventListeners,
                    attachSelect2Operador,
                    // attachVerificarData,
                    attachHistorico,
                    attachMaisDetalhes
                ] // Callback após carregar as solicitações
            );

            if (document.getElementById('headingAguardandoPrimeiroAtendimento')) {
                fetchSolicitacoes(
                    "aguardando-primeiro-atendimento/",             // URL base
                    "aguardando-primeiro-atendimento-container",    // ID do container onde os dados serão inseridos
                    "loadMoreAguardandoPrimeiroAtendimento",        // ID do botão de 'load more'
                    params,                                         // Parâmetros do filtro
                    [
                        attachExecutar1OrdemEventListeners,
                        attachStatusChangeListeners,
                        escolherPlanoPreventiva,
                        attachModalEventListeners
                    ] // Callback após carregar as solicitações
                );
            }
            
        });

        function fetchSolicitacoes(url, container, loadMoreButtonId, params, callbacks = []) {
            
            const loadMoreButton = document.getElementById(loadMoreButtonId);

            // document.getElementById(container).innerHTML = 'Carregando...';
            document.getElementById(container).innerHTML = `<div class="loading-overlay" id="loading-historico">
                                                            <div class="spinner"></div>
                                                            </div>`
            loadMoreButton.style.display = 'none';

            let fetchUrl = `${url}?page=1`;

            if (params) {
                fetchUrl += `&${params}`;
            }

            fetch(fetchUrl, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById(container).innerHTML = data.html;

                if (data.nextPage) {
                    loadMoreButton.setAttribute('data-next-page', data.nextPage);
                    loadMoreButton.disabled = false;
                    loadMoreButton.style.display = 'block';

                    if (!loadMoreButton.hasListener) {
                        // Use uma IIFE para capturar `params` e `callbacks` corretamente
                        loadMoreButton.addEventListener('click', () => {
                            loadMoreSolicitacoes(
                                loadMoreButtonId, url, container, params, callbacks
                            );
                        });

                        loadMoreButton.hasListener = true;
                    }
                } else {
                    loadMoreButton.style.display = 'none';
                }

                callbacks.forEach(callback => {
                    if (typeof callback === 'function') {
                        callback();
                    }
                });

            })
            .catch(error => console.error("Erro ao carregar solicitações:", error));
        }

        // Função para carregar mais solicitações
        function loadMoreSolicitacoes(loadMoreButtonId, url, container, params = '', callbacks = []) {
            
            var filterForm = document.getElementById('filter-form');
            var formData = new FormData(filterForm);
            var params = new URLSearchParams(formData).toString();

            var loadMoreButton = document.getElementById(loadMoreButtonId);
            if (!loadMoreButton) {
                console.error("Botão de 'load more' não encontrado.");
                return;
            }

            let nextPage = loadMoreButton.getAttribute('data-next-page');
            if (!nextPage) {
                console.error("Nenhuma página disponível para carregar.");
                loadMoreButton.style.display = 'none';
                return;
            }

            loadMoreButton.disabled = true; // Desabilita o botão para evitar múltiplos cliques

            // Adiciona os parâmetros de filtro na URL da próxima página
            var fetchUrl = url + "?page=" + nextPage;
            if (params) {
                fetchUrl += "&" + params;
            }

            fetch(fetchUrl, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById(container).insertAdjacentHTML('beforeend', data.html);

                if (data.nextPage) {
                    loadMoreButton.setAttribute('data-next-page', data.nextPage);
                    loadMoreButton.disabled = false;
                    loadMoreButton.style.display = 'block';  // Mostra o botão se há mais páginas
                } else {
                    loadMoreButton.style.display = 'none';
                }

                callbacks.forEach(callback => {
                    if (typeof callback === 'function') {
                        callback();
                    }
                });
            })
            .catch(error => {
                console.error("Erro ao carregar mais solicitações:", error);
                loadMoreButton.disabled = false;
            });
        }

        function loadSection(url, containerId, callbacks = []) {  // Aceita múltiplos callbacks usando o operador rest
            fetch(url)
                .then(response => response.text())
                .then(html => {

                    document.getElementById(containerId).innerHTML = html;

                    // Executa todos os callbacks (se houver) após o carregamento da seção
                    callbacks.forEach(callback => {
                        if (typeof callback === 'function') {
                            callback();
                        }
                    });
                })
                .catch(error => {
                    console.error("Erro ao carregar seção:", error);
                });

        }

        function attachStatusChangeListeners() {
            const statusSelects = document.querySelectorAll('select[id^="status_inicial_"]');

            statusSelects.forEach(function(statusSelect) {
                // Extrai o ID dinâmico da solicitação (pk)
                const pk = statusSelect.id.split('_')[2]; // Pega o ID da solicitação a partir do ID do select
                const dataProgramacao = document.getElementById('data_programacao_' + pk);
                const campoProgramacao = document.getElementById('campoProgramacao_' + pk);
                const campoAtribuirOperador = document.getElementById('rowAtribuirOperador_' + pk)
                const campoOperador = document.getElementById('operador_'+pk)
                const campoNivelPrioridade = document.getElementById('prioridade_'+pk)
                const campoTipoManutencao = document.getElementById('tipo_manutencao_'+pk)
                const campoAreaManutencao = document.getElementById('area_manutencao_'+pk)
                
                // Função para verificar e alterar a visibilidade e obrigatoriedade do campo de data
                function toggleDataProgramacao() {
                    if (statusSelect.value === 'rejeitar') {
                        // Oculta o campo de data e remove a obrigatoriedade
                        campoProgramacao.style.display = 'none';
                        campoProgramacao.value = '';
                        campoAtribuirOperador.style.display = 'none';
                        campoAtribuirOperador.value = '';
                        dataProgramacao.removeAttribute('required');
                        campoOperador.removeAttribute('required');
                        campoNivelPrioridade.removeAttribute('required');
                        campoTipoManutencao.removeAttribute('required');
                        campoAreaManutencao.removeAttribute('required');
                    } else if (statusSelect.value === 'aprovar') {
                        // Exibe o campo de data e torna-o obrigatório
                        campoProgramacao.style.display = 'block';
                        campoAtribuirOperador.style.display = 'block';
                        dataProgramacao.setAttribute('required', 'required');
                        campoOperador.setAttribute('required', 'required');
                        campoNivelPrioridade.setAttribute('required', 'required');
                        campoTipoManutencao.setAttribute('required', 'required');
                        campoAreaManutencao.setAttribute('required', 'required');

                    }
                }

                // Adiciona o listener de mudança (change) ao campo select
                statusSelect.addEventListener('change', toggleDataProgramacao);

                // Chama a função inicialmente para ajustar o estado inicial
                toggleDataProgramacao();
            });
        }

        // Função para adicionar event listeners aos formulários de iniciar ordem
        function attachExecutarOrdemEventListeners() {
            const forms = document.querySelectorAll('.formExecucaoProducao');

            forms.forEach(function(form) {
                form.addEventListener('submit', function(event) {
                    
                    var campoPvlye,campoPaplus, campoPhagua;

                    // Verificação de datas
                    const dataInicioElement = document.getElementById('id_data_inicio');
                    const dataFimElement = document.getElementById('id_data_fim');

                    if (dataInicioElement && dataFimElement) {
                        const dataInicio = new Date(dataInicioElement.value);
                        const dataFim = new Date(dataFimElement.value);

                        if (dataInicioElement.value && dataFimElement.value) {
                            if (dataFim < dataInicio) {
                                event.preventDefault(); // Impede o envio do formulário
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'Atenção',
                                    text: 'A data de fim deve ser maior que a data de início.',
                                    confirmButtonText: 'OK'
                                });
                                return; // Impede a execução de outras ações
                            }
                        }
                    }
                    
                    var campoPvlye = document.getElementById('pvlye');
                    var campoPaplus = document.getElementById('paplus');
                    var campoPhagua = document.getElementById('phagua');
                    
                    if (campoPvlye){
                        campoPvlye.addEventListener('input', function() {
                            this.value = this.value.replace(',', '.');
                        });
                    }
                    if (campoPaplus){
                        campoPaplus.addEventListener('input', function() {
                            this.value = this.value.replace(',', '.');
                        });
                    }                    
                    if (campoPhagua){
                        campoPhagua.addEventListener('input', function() {
                            this.value = this.value.replace(',', '.');
                        });
                    }

                    // Verificar se algum radio button foi selecionado
                    const radioGroups = form.querySelectorAll('input[type="radio"][name]');
                    let allRadioGroupsChecked = true;

                    // Agrupar por nome e verificar se pelo menos uma opção está marcada em cada grupo
                    const uniqueNames = [...new Set(Array.from(radioGroups).map(radio => radio.name))];

                    uniqueNames.forEach(name => {
                        const radios = form.querySelectorAll(`input[type="radio"][name="${name}"]`);
                        const isChecked = Array.from(radios).some(radio => radio.checked);
                        if (!isChecked) {
                            allRadioGroupsChecked = false;
                        }
                    });

                    if (!allRadioGroupsChecked) {
                        event.preventDefault();
                        Swal.fire({
                            icon: 'warning',
                            title: 'Atenção',
                            text: 'Por favor, selecione uma opção em todas as perguntas antes de enviar.',
                            confirmButtonText: 'OK'
                        });
                        return; // Impede o envio do formulário
                    }

                    event.preventDefault(); // Impede o envio tradicional do formulário

                    // Obter a URL de envio
                    const url = form.getAttribute('action');
                    const modalId = form.dataset.modalId;

                    // Criar um objeto FormData para capturar os dados do formulário
                    const formData = new FormData(form);

                    // Exibe o modal de carregamento
                    Swal.fire({
                        title: 'Processando...',
                        text: 'Aguarde enquanto processamos sua solicitação.',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading(); // Exibe o spinner de carregamento
                        }
                    });

                    // Enviar a requisição AJAX
                    fetch(url, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            return response.json(); // Continua para o próximo .then com os dados do JSON
                        } else {
                            // Tenta capturar a mensagem de erro do backend no formato JSON
                            return response.json()
                                .then(errorData => {
                                    throw new Error(errorData.error || 'Erro ao executar a ordem.'); // Lança o erro com a mensagem específica do backend
                                })
                                .catch(() => {
                                    throw new Error('Erro ao executar a ordem.'); // Lança uma mensagem genérica se o JSON falhar
                                });
                        }
                    })    
                    .then(data => {
                        if (data.success) {
                            Promise.all([
                                document.getElementById('headingAguardandoPrimeiroAtendimento') 
                                    ? loadSection("aguardando-primeiro-atendimento/", "aguardando-primeiro-atendimento-container", [
                                        attachExecutar1OrdemEventListeners,
                                        attachStatusChangeListeners,
                                        escolherPlanoPreventiva,
                                        attachModalEventListeners
                                    ])
                                    : Promise.resolve(),

                                document.getElementById('headingMaquinasParadas') 
                                    ? loadSection("maquinas-paradas/", "maquinas-paradas-container")
                                    : Promise.resolve(),

                                loadSection("solicitacoes/", "solicitacoes-container", [
                                    attachReprogramarOrdemEventListeners,
                                    attachExecutarOrdemEventListeners,
                                    mudancaStatusFinalizada,
                                    attachStatusReenviarWpp,
                                    attachModalEventListeners,
                                    attachSelect2Operador,
                                    // attachVerificarData,
                                    attachHistorico,
                                    attachMaisDetalhes
                                ])

                            ]).then(() => {

                            }).catch(error => {
                                console.error("Erro ao carregar as seções:", error);
                            });

                            // Fechar o modal
                            const modal = document.getElementById(modalId);
                            const modalInstance = bootstrap.Modal.getInstance(modal);
                            modalInstance.hide();

                            // Mostrar o popup de sucesso
                            Swal.fire({
                                icon: 'success',
                                title: 'Sucesso',
                                text: 'Execução feita com sucesso!',
                                confirmButtonText: 'OK'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Erro:', error.message);
                        Swal.fire({
                            icon: 'error',
                            title: 'Erro',
                            text: error.message || 'Ocorreu um erro ao executar a ordem. Tente novamente.',
                            confirmButtonText: 'OK'
                        });
                    });
                });
            });
        }

        // Função para adicionar event listeners aos formulários de finalizar ordem
        function attachExecutar1OrdemEventListeners() {
            const forms = document.querySelectorAll('.form1ExecucaoProducao');
            forms.forEach(function(form) {
                form.addEventListener('submit', function(event) {
                    event.preventDefault(); // Impede o envio tradicional do formulário

                    const dataAberturaField = form.querySelector('#data_abertura_info');
                    const dataProgramacaoField = form.querySelector('[name="data_programacao"]');

                    if (dataAberturaField && dataProgramacaoField) {

                        const [anoProgramacao, mesProgramacao, diaProgramacao] = dataProgramacaoField.value.split('-');

                        // Extrair somente a data (ano, mês, dia)
                        const dataAbertura = new Date(dataAberturaField.value);
                        const dataProgramacao = new Date(anoProgramacao, mesProgramacao - 1, diaProgramacao);

                        // Normalizar para apenas data (zerar hora, minuto, segundo, etc.)
                        const dataAberturaNormalizada = new Date(dataAbertura.getFullYear(), dataAbertura.getMonth(), dataAbertura.getDate());
                        const dataProgramacaoNormalizada = new Date(dataProgramacao.getFullYear(), dataProgramacao.getMonth(), dataProgramacao.getDate());

                        // Verificar se a data de programação é menor que a data de abertura
                        if (dataProgramacaoNormalizada < dataAberturaNormalizada) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Erro na validação',
                                text: 'A data de programação não pode ser menor que a data de abertura.',
                                confirmButtonText: 'OK'
                            });
                            return; // Impede o envio do formulário
                        }
                    }

                    // Obter a URL de envio
                    const url = form.getAttribute('action');
                    const modalId = form.dataset.modalId;

                    // Criar um objeto FormData para capturar os dados do formulário
                    const formData = new FormData(form);

                    // Exibe o modal de carregamento
                    Swal.fire({
                        title: 'Processando...',
                        text: 'Aguarde enquanto processamos sua solicitação.',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading(); // Exibe o spinner de carregamento
                        }
                    });

                    // Enviar a requisição AJAX
                    fetch(url, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        }
                    })
                    .then(response => {

                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error('Erro ao finalizar a ordem.');
                        }
                    })
                    .then(data => {

                        if (data.success) {
                            Promise.all([

                            document.getElementById('headingAguardandoPrimeiroAtendimento') 
                                ? loadSection("aguardando-primeiro-atendimento/", "aguardando-primeiro-atendimento-container", [
                                    attachExecutar1OrdemEventListeners,
                                    attachStatusChangeListeners,
                                    escolherPlanoPreventiva,
                                    attachModalEventListeners,
                                    
                                ])
                                : Promise.resolve(),  // Garante que o array de Promises sempre receba um valor
                            
                            document.getElementById('headingMaquinasParadas') 
                                ? loadSection("maquinas-paradas/", "maquinas-paradas-container")
                                : Promise.resolve(),  // Garante que o array de Promises sempre receba um valor

                            loadSection("solicitacoes/", "solicitacoes-container", [
                                attachReprogramarOrdemEventListeners,
                                attachExecutarOrdemEventListeners,
                                mudancaStatusFinalizada,
                                attachStatusReenviarWpp,
                                attachModalEventListeners,
                                attachSelect2Operador,
                                // attachVerificarData,
                                attachHistorico,
                                attachMaisDetalhes
                            ]),



                            ]).then(() => {
                            }).catch(error => {
                                console.error("Erro ao carregar as seções:", error);
                            });

                            // Fechar o modal
                            const modal = document.getElementById(modalId);
                            const modalInstance = bootstrap.Modal.getInstance(modal);
                            modalInstance.hide();
                            
                            // Mostrar o popup de sucesso
                            Swal.fire({
                                icon: 'success',
                                title: 'Sucesso',
                                text: 'Ordem executada com sucesso!',
                                confirmButtonText: 'OK'
                            });

                        }
                    })
                    .catch(error => {
                        console.error('Erro:', error);
                        alert('Ocorreu um erro ao executar a ordem. Tente novamente.');
                        Swal.fire({
                            icon: 'error',
                            title: 'Erro',
                            text: 'Ocorreu um erro ao executar a ordem. Tente novamente.',
                            confirmButtonText: 'OK'
                        });
                    });
                });
            });
        }

        // Função para adicionar event listeners aos formulários de finalizar ordem
        function attachReprogramarOrdemEventListeners() {
            const forms = document.querySelectorAll('.formReprogramarOrdemProducao');
            forms.forEach(function(form) {
                form.addEventListener('submit', function(event) {
                    event.preventDefault(); // Impede o envio tradicional do formulário

                    // Obter a URL de envio
                    const url = form.getAttribute('action');
                    const modalId = form.dataset.modalId;

                    // Criar um objeto FormData para capturar os dados do formulário
                    const formData = new FormData(form);
                    console.log(modalId);

                    // Exibe o modal de carregamento
                    Swal.fire({
                        title: 'Processando...',
                        text: 'Aguarde enquanto processamos sua solicitação.',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading(); // Exibe o spinner de carregamento
                        }
                    });

                    // Enviar a requisição AJAX
                    fetch(url, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        }
                    })
                    // .then(response => {
                    //     if (response.ok) {
                    //         return response.json();
                    //     } else {
                    //         throw new Error('Erro ao finalizar a ordem.');
                    //     }
                    // })
                    .then(response => {
                        if (response.ok) {
                            return response.json(); // Continua para o próximo .then com os dados do JSON
                        } else {
                            // Tenta capturar a mensagem de erro do backend no formato JSON
                            return response.json()
                                .then(errorData => {
                                    console.log(errorData);
                                    throw new Error(errorData.error || 'Erro ao reprogramar a ordem.'); // Lança o erro com a mensagem específica do backend
                                })
                                .catch(() => {
                                    throw new Error('Erro ao reprogramar a ordem.'); // Lança uma mensagem genérica se o JSON falhar
                                });
                        }
                    })
                    .then(data => {

                        if (data.success) {
                            Promise.all([

                            document.getElementById('headingAguardandoPrimeiroAtendimento') 
                                ? loadSection("aguardando-primeiro-atendimento/", "aguardando-primeiro-atendimento-container", [
                                    attachExecutar1OrdemEventListeners,
                                    attachStatusChangeListeners,
                                    escolherPlanoPreventiva,
                                    attachModalEventListeners,
                                    
                                ])
                                : Promise.resolve(),  // Garante que o array de Promises sempre receba um valor
                            
                            document.getElementById('headingMaquinasParadas') 
                                ? loadSection("maquinas-paradas/", "maquinas-paradas-container")
                                : Promise.resolve(),  // Garante que o array de Promises sempre receba um valor

                            loadSection("solicitacoes/", "solicitacoes-container", [
                                attachReprogramarOrdemEventListeners,
                                attachExecutarOrdemEventListeners,
                                mudancaStatusFinalizada,
                                attachStatusReenviarWpp,
                                attachModalEventListeners,
                                attachSelect2Operador,
                                // attachVerificarData,
                                attachHistorico,
                                attachMaisDetalhes
                            ]),



                            ]).then(() => {
                            }).catch(error => {
                                console.error("Erro ao carregar as seções:", error);
                            });

                            // Fechar o modal
                            const modal = document.getElementById(modalId);
                            const modalInstance = bootstrap.Modal.getInstance(modal);
                            modalInstance.hide();
                            
                            // Mostrar o popup de sucesso
                            Swal.fire({
                                icon: 'success',
                                title: 'Sucesso',
                                text: 'Ordem reprogramada com sucesso!',
                                confirmButtonText: 'OK'
                            });

                        }
                    })
                    .catch(error => {
                        console.error('Erro:', error);
                        alert('Ocorreu um erro ao reprogramar a ordem. Tente novamente.');
                        Swal.fire({
                            icon: 'error',
                            title: 'Erro',
                            text: 'Ocorreu um erro ao reprogramar a ordem. Tente novamente.',
                            confirmButtonText: 'OK'
                        });
                    });
                });
            });
        }

        function mudancaStatusFinalizada(){
            document.querySelectorAll('[id^="id_status_"]').forEach(selectElement => {
                selectElement.addEventListener('change', function() {
                    const isFinalizada = this.value === 'finalizada';
                    const modalId = this.id.split('_').pop(); // Obtém o identificador exclusivo do modal

                    const containerReabrirOrdem = document.querySelector(`#executarModal${modalId} #container-reabrir-ordem`)
                    const solicitarAberturaNovaOrdem = document.querySelector(`#executarModal${modalId} #solicitarAberturaNovaOrdem_${modalId}`)
                    const checkboxSim = document.querySelector(`#executarModal${modalId} #id_apos_exec_maq_parada_sim`);
                    const checkboxNao = document.querySelector(`#executarModal${modalId} #id_apos_exec_maq_parada_nao`);

                    if (isFinalizada) {
                        checkboxNao.checked = true;
                        checkboxSim.disabled = true;
                        containerReabrirOrdem.style.display = 'block';
                        solicitarAberturaNovaOrdem.setAttribute('required', 'required');
                    } else {
                        checkboxNao.checked = false;
                        checkboxSim.disabled = false;
                        containerReabrirOrdem.style.display = 'none';
                        solicitarAberturaNovaOrdem.removeAttribute('required');
                    }
                });
            });

            document.querySelectorAll('[id^="solicitarAberturaNovaOrdem_"]').forEach((selectElement) => {
                selectElement.addEventListener('change', function () {
                    const abrirOrdem = this.value.toLowerCase() === 'sim';  // Confirma se o valor é 'sim'
                    const modalId = this.id.split('_').pop();  // Obtém o identificador único do modal

                    const motivoElement = document.querySelector(`#executarModal${modalId} #motivoNovaOrdem`);
                    const inputMotivoElement = document.querySelector(`#executarModal${modalId} #motivoNovaOrdemInput`);

                    if (motivoElement && inputMotivoElement) {
                        motivoElement.style.display = abrirOrdem ? 'block' : 'none';

                        // Adiciona ou remove o atributo 'required' dinamicamente
                        if (abrirOrdem) {
                            inputMotivoElement.setAttribute('required', 'required');
                        } else {
                            inputMotivoElement.removeAttribute('required');
                        }
                    } else {
                        console.error(`Elemento #motivoNovaOrdem ou #motivoNovaOrdemInput não encontrado no modal ${modalId}`);
                    }
                });
            });

        };
        

        

        function attachModalEventListeners() {
            
            document.querySelectorAll('[id^="eq_falha_"]').forEach(function(editLink) {
                editLink.addEventListener('change', function(event) {
                    const solicitacaoPk = editLink.id.split('_')[2]; // Obtém o ID da solicitação
                    const modalEditarOrdem = document.getElementById(`editarOrdemInicialModal${solicitacaoPk}`);
                    const divPlanoPreventiva = modalEditarOrdem.querySelector('#rowEscolhaPlano');

                    const divsSolda = modalEditarOrdem.querySelectorAll('.div-solda');
                    
                    divsSolda[1].style.display = 'flex';

                    const selectTipoManutencao = modalEditarOrdem.querySelector(`#tipo_manutencao_${solicitacaoPk}`);
                    selectTipoManutencao.selectedIndex = -1;
                    let tipoEquipamento = $(`#eq_falha_${solicitacaoPk} option:selected`).val();
                    atualizarSelectMaquina(this,tipoEquipamento);

                    $(`#id_maquina_${solicitacaoPk}`).on('change', function() {
                        var codigoMaquina = this.value;
                        const url = `/plano-preventiva/criar/${codigoMaquina}/`;
                        divPlanoPreventiva.innerHTML = `<div class="col-sm-12">
                                                        <label for="">Escolha o plano</label>
                                                        <select class="form-control" name="escolherPlanoPreventiva" id="escolherPlanoPreventiva" data-id-maquina="${codigoMaquina}">
                                                            <option value="">Carregando...</option>
                                                        </select>
                                                        <a class="form-control" href="${url}">Criar novo plano</a>
                                                    </div>`
                        checkMaquinaParada(solicitacaoPk,this);
                    });

                    const divTipoFerramenta = modalEditarOrdem.querySelector('.div-tipo-ferramenta');
                    const divCodFerramenta = modalEditarOrdem.querySelector('.div-cod-ferramenta');

                    const divSetorMaqSolda = modalEditarOrdem.querySelector('.div-setor-maq-solda');

                    divSetorMaqSolda.style.display = 'none';
                    
                    if (modalEditarOrdem.querySelector(`#setor_maq_solda_${solicitacaoPk}`)){
                        modalEditarOrdem.querySelector(`#setor_maq_solda_${solicitacaoPk}`).selectedIndex = -1;
                        modalEditarOrdem.querySelector(`#setor_maq_solda_${solicitacaoPk}`).disabled = true;
                    };

                    if (tipoEquipamento === 'ferramentas'){
                        //Retirando a obrigatoriedade do select máquina
                        $(`#id_maquina_${solicitacaoPk}`).attr('disabled',true);

                        divPlanoPreventiva.innerHTML = '';
                        divsSolda[1].style.display = 'flex';

                        // Remove o campo de texto e adiciona um <select> no lugar
                        divTipoFerramenta.innerHTML = `
                            <label for="">Tipo de ferramenta <span class="required">*</span></label>
                            <select class="form-control select2_tipo_ferramenta" name="tipo_ferramenta" id="tipo_ferramenta_${solicitacaoPk}" required>
                                <option value="">--</option>
                                <option value="esmerilhadeira">Esmerilhadeira</option>
                                <option value="tocha">Tocha</option>
                            </select>
                        `;
                        divTipoFerramenta.style.display = 'block';
                        divCodFerramenta.style.display = 'block';
                        
                        //Habilitando o campo codigo de ferramenta
                        if (modalEditarOrdem.querySelector(`.input-cod-ferramenta`)){
                            modalEditarOrdem.querySelector(`.input-cod-ferramenta`).disabled = false;
                        };
                    }else{
                        //Desabilitar os campos de ferramentas
                        if (modalEditarOrdem.querySelector(`#tipo_ferramenta_${solicitacaoPk}`)){
                            modalEditarOrdem.querySelector(`#tipo_ferramenta_${solicitacaoPk}`).selectedIndex = -1;
                            modalEditarOrdem.querySelector(`#tipo_ferramenta_${solicitacaoPk}`).disabled = true;
                        }

                        if (modalEditarOrdem.querySelector(`.input-cod-ferramenta`)){
                            modalEditarOrdem.querySelector(`.input-cod-ferramenta`).value = '';
                            modalEditarOrdem.querySelector(`.input-cod-ferramenta`).disabled = true;
                        }
                        divTipoFerramenta.style.display = 'none';
                        divCodFerramenta.style.display = 'none';

                        

                        if (tipoEquipamento === 'maquina_de_solda'){
                            divSetorMaqSolda.innerHTML = `
                                                        <label for="">Setor Máquina de solda <span class="required">*</span></label>
                                                        <select class="form-control select2_setor_maq_solda" name="setor_maq_solda" id="setor_maq_solda_${solicitacaoPk}" required>
                                                            <option value="">--</option>
                                                            <option value="laterais">Laterais</option>
                                                            <option value="eixos">Eixos</option>
                                                            <option value="icamentos">Içamentos</option>
                                                            <option value="plataforma">Plataforma</option>
                                                            <option value="chassi">Chassi</option>
                                                            <option value="tanque">Tanque</option>
                                                            <option value="cacamba">Caçamba</option>
                                                            <option value="serralheria">Serralheria</option>
                                                            <option value="fueiro">Fueiro</option>
                                                        </select>
                                                        `
                            divSetorMaqSolda.style.display = 'block';
                        }
                    }
  
                });
            });

            
            document.querySelectorAll('#habilitarEdicaoMaquina').forEach(function(editLink) {
                editLink.addEventListener('click', function(event) {
                    event.preventDefault();
                    
                    const container = editLink.closest('div[id^="editarMaquina_"]');
                    const solicitacaoPk = container.id.split('_')[1]; // Obtém o ID da solicitação
                    const modalEditarOrdem = document.getElementById(`editarOrdemInicialModal${solicitacaoPk}`);
                    
                    // Remove o campo de texto e adiciona um <select> no lugar
                    container.innerHTML = `
                        <select class="form-control select2_maquina" name="id_maquina" id="id_maquina_${solicitacaoPk}" required>
                            <option value="">Carregando máquinas...</option>
                        </select>
                    `;

                    // Verifica o valor do campo Setor
                    let setor = $(`#id_setor_${solicitacaoPk}`).val();
                    if (setor == null){
                        const divSetor = document.getElementById(`editarSetor_${solicitacaoPk}`); 
                        setor = divSetor.querySelector('input').value;
                    }
                    

                    // Faz a requisição AJAX para carregar as máquinas
                    fetch(`/solicitacao/ajax/get-all-maquinas/${setor}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.results) {
                                updateSelectElement(`id_maquina_${solicitacaoPk}`, data.results, function(optionData) {
                                    return optionData.text;  // Exibe o nome da máquina
                                });

                                // Inicializa o Select2 após adicionar as opções
                                $(`#id_maquina_${solicitacaoPk}`).select2({
                                    placeholder: "Selecione a máquina",
                                    allowClear: true,
                                    width: '100%',
                                    dropdownParent: $(`#editarMaquina_${solicitacaoPk}`), // Garante que o dropdown esteja contido no modal
                                    language: {
                                        noResults: function() {
                                            return "Nenhuma máquina foi encontrada nesse setor!";
                                        }}
                                });
                                
                                $(`#id_maquina_${solicitacaoPk}`).on('change', function() {
                                    const divPlanoPreventiva = modalEditarOrdem.querySelector('#rowEscolhaPlano');
                                    var codigoMaquina = this.value;
                                    const url = `/plano-preventiva/criar/${codigoMaquina}/`;
                                    divPlanoPreventiva.innerHTML = `<div class="col-sm-12">
                                                                        <label for="">Escolha o plano</label>
                                                                        <select class="form-control" name="escolherPlanoPreventiva" id="escolherPlanoPreventiva" data-id-maquina="${codigoMaquina}">
                                                                            <option value="">Carregando...</option>
                                                                        </select>
                                                                        <a class="form-control" href="${url}">Criar novo plano</a>
                                                                    </div>`;
                                    checkMaquinaParada(solicitacaoPk,this);
                                });



                            } else {
                                console.error('Nenhuma máquina encontrada.');
                            }
                        })
                        .catch(error => {
                            console.error('Erro ao carregar as máquinas:', error);
                        });
                });
            });
            document.querySelectorAll('#habilitarEdicaoSetor').forEach(function(editLink) {
                editLink.addEventListener('click', function(event) {
                    event.preventDefault();
                    
                    
                    const container = editLink.closest('div[id^="editarSetor_"]');
                    const solicitacaoPk = container.id.split('_')[1]; // Obtém o ID da solicitação
                    const modalEditarOrdem = document.getElementById(`editarOrdemInicialModal${solicitacaoPk}`);
                    const divPlanoPreventiva = modalEditarOrdem.querySelector('#rowEscolhaPlano');
                    // Remove o campo de texto e adiciona um <select> no lugar
                    container.innerHTML = `
                        <select class="form-control select2_setor" name="id_setor" id="id_setor_${solicitacaoPk}" required>
                            <option value="">Carregando setores...</option>
                        </select>
                    `;
                    // Faz a requisição AJAX para carregar as máquinas
                    fetch('/solicitacao/ajax/get-all-setores/')
                        .then(response => response.json())
                        .then(data => {
                            if (data.results) {
                                updateSelectElement(`id_setor_${solicitacaoPk}`, data.results, function(optionData) {
                                    return optionData.text;  // Exibe o nome da máquina
                                });

                                // Inicializa o Select2 após adicionar as opções
                                $(`#id_setor_${solicitacaoPk}`).select2({
                                    placeholder: "Selecione o setor",
                                    allowClear: true,
                                    width: '100%',
                                    dropdownParent: $(`#editarSetor_${solicitacaoPk}`) // Garante que o dropdown esteja contido no modal
                                });

                                
                                
                                $(`#id_setor_${solicitacaoPk}`).on('change', function() {
                                    atualizarSelectMaquina(this,'');

                                    //Retirando o texto de máquina parada apos mudar o setor
                                    const textoMaquinaParada = document.getElementById(`returnTextMaquinaParada${solicitacaoPk}`);
                                    textoMaquinaParada.style.display = 'none';

                                    $(`#id_maquina_${solicitacaoPk}`).on('change', function() {
                                        var codigoMaquina = this.value;
                                        const url = `/plano-preventiva/criar/${codigoMaquina}/`;
                                        divPlanoPreventiva.innerHTML = `<div class="col-sm-12">
                                                                        <label for="">Escolha o plano</label>
                                                                        <select class="form-control" name="escolherPlanoPreventiva" id="escolherPlanoPreventiva" data-id-maquina="${codigoMaquina}">
                                                                            <option value="">Carregando...</option>
                                                                        </select>
                                                                        <a class="form-control" href="${url}">Criar novo plano</a>
                                                                    </div>`;
                                        checkMaquinaParada(solicitacaoPk,this);
                                    });
                                    
                                    const divsSolda = modalEditarOrdem.querySelectorAll('.div-solda');
                                    if ($(`#id_setor_${solicitacaoPk} option:selected`).text() != 'Solda'){
                                        // div-solda input-solda
                                        
                                        if (divsSolda){
                                            divsSolda.forEach(divSolda =>{
                                                divSolda.querySelectorAll('.input-solda').forEach(inputSolda =>{
                                                    inputSolda.disabled = true;
                                                    inputSolda.value = '';
                                                })
                                                divSolda.style.display = 'none';
                                            })
                                            if (modalEditarOrdem.querySelector(`#eq_falha_${solicitacaoPk}`)){
                                                modalEditarOrdem.querySelector(`#eq_falha_${solicitacaoPk}`).selectedIndex = -1;
                                                modalEditarOrdem.querySelector(`#eq_falha_${solicitacaoPk}`).disabled = true;
                                            }
                                            if (modalEditarOrdem.querySelector(`#tipo_ferramenta_${solicitacaoPk}`)){
                                                modalEditarOrdem.querySelector(`#tipo_ferramenta_${solicitacaoPk}`).selectedIndex = -1;
                                                modalEditarOrdem.querySelector(`#tipo_ferramenta_${solicitacaoPk}`).disabled = true;
                                            }
                                            if (modalEditarOrdem.querySelector(`#setor_maq_solda_${solicitacaoPk}`)){
                                                modalEditarOrdem.querySelector(`#setor_maq_solda_${solicitacaoPk}`).selectedIndex = -1;
                                                modalEditarOrdem.querySelector(`#setor_maq_solda_${solicitacaoPk}`).disabled = true;
                                            };

                                        }
                                    }else{
                                        if (divsSolda){
                                            divsSolda[0].style.display = 'flex';
                                            divsSolda[1].style.display = 'none';
                                            const divEquipamentoFalha = modalEditarOrdem.querySelector('.div-eq-falha');
                                            // Remove o campo de texto e adiciona um <select> no lugar
                                            divEquipamentoFalha.innerHTML = `
                                                <label for="">Equipamento em falha <span class="required">*</span></label>
                                                 <select class="form-control select2_eq_falha" name="eq_falha" id="eq_falha_${solicitacaoPk}" required>
                                                     <option value="">--</option>
                                                     <option value="maquina_de_solda">Máquina de Solda</option>
                                                     <option value="monovia">Monovia</option>
                                                     <option value="ferramentas">Ferramentas</option>
                                                     <option value="robo_kuka" >SO-RB-01 - ROBÔ - KUKA</option>
                                                     <option value="outros">Outros</option>
                                                 </select>
                                            `;
                                            divEquipamentoFalha.style.display = 'block';
                                            $(`#eq_falha_${solicitacaoPk}`).on('change',function(){
                                                divsSolda[1].style.display = 'flex';

                                                const selectTipoManutencao = modalEditarOrdem.querySelector(`#tipo_manutencao_${solicitacaoPk}`);
                                                selectTipoManutencao.selectedIndex = -1;
                                                let tipoEquipamento = $(`#eq_falha_${solicitacaoPk} option:selected`).val();

                                                atualizarSelectMaquina(this,tipoEquipamento);

                                                $(`#id_maquina_${solicitacaoPk}`).on('change', function() {
                                                    var codigoMaquina = this.value;
                                                    const url = `/plano-preventiva/criar/${codigoMaquina}/`;
                                                    divPlanoPreventiva.innerHTML = `<div class="col-sm-12">
                                                                                    <label for="">Escolha o plano</label>
                                                                                    <select class="form-control" name="escolherPlanoPreventiva" id="escolherPlanoPreventiva" data-id-maquina="${codigoMaquina}">
                                                                                        <option value="">Carregando...</option>
                                                                                    </select>
                                                                                    <a class="form-control" href="${url}">Criar novo plano</a>
                                                                                </div>`
                                                    checkMaquinaParada(solicitacaoPk,this);
                                                });

                                                const divTipoFerramenta = modalEditarOrdem.querySelector('.div-tipo-ferramenta');
                                                const divCodFerramenta = modalEditarOrdem.querySelector('.div-cod-ferramenta');

                                                const divSetorMaqSolda = modalEditarOrdem.querySelector('.div-setor-maq-solda');

                                                divSetorMaqSolda.style.display = 'none';
                                                
                                                if (modalEditarOrdem.querySelector(`#setor_maq_solda_${solicitacaoPk}`)){
                                                    modalEditarOrdem.querySelector(`#setor_maq_solda_${solicitacaoPk}`).selectedIndex = -1;
                                                    modalEditarOrdem.querySelector(`#setor_maq_solda_${solicitacaoPk}`).disabled = true;
                                                };

                                                if (tipoEquipamento === 'ferramentas'){
                                                    //Retirando a obrigatoriedade do select máquina
                                                    $(`#id_maquina_${solicitacaoPk}`).attr('disabled',true);

                                                    divPlanoPreventiva.innerHTML = '';
                                                    divsSolda[1].style.display = 'flex';

                                                    // Remove o campo de texto e adiciona um <select> no lugar
                                                    divTipoFerramenta.innerHTML = `
                                                        <label for="">Tipo de ferramenta <span class="required">*</span></label>
                                                        <select class="form-control select2_tipo_ferramenta" name="tipo_ferramenta" id="tipo_ferramenta_${solicitacaoPk}" required>
                                                            <option value="">--</option>
                                                            <option value="esmerilhadeira">Esmerilhadeira</option>
                                                            <option value="tocha">Tocha</option>
                                                        </select>
                                                    `;
                                                    divTipoFerramenta.style.display = 'block';
                                                    divCodFerramenta.style.display = 'block';
                                                    
                                                    //Habilitando o campo codigo de ferramenta
                                                    if (modalEditarOrdem.querySelector(`.input-cod-ferramenta`)){
                                                        modalEditarOrdem.querySelector(`.input-cod-ferramenta`).disabled = false;
                                                    };
                                                }else{
                                                    //Desabilitar os campos de ferramentas
                                                    if (modalEditarOrdem.querySelector(`#tipo_ferramenta_${solicitacaoPk}`)){
                                                        modalEditarOrdem.querySelector(`#tipo_ferramenta_${solicitacaoPk}`).selectedIndex = -1;
                                                        modalEditarOrdem.querySelector(`#tipo_ferramenta_${solicitacaoPk}`).disabled = true;
                                                    }

                                                    if (modalEditarOrdem.querySelector(`.input-cod-ferramenta`)){
                                                        modalEditarOrdem.querySelector(`.input-cod-ferramenta`).value = '';
                                                        modalEditarOrdem.querySelector(`.input-cod-ferramenta`).disabled = true;
                                                    }
                                                    divTipoFerramenta.style.display = 'none';
                                                    divCodFerramenta.style.display = 'none';

                                                    

                                                    if (tipoEquipamento === 'maquina_de_solda'){
                                                        divSetorMaqSolda.innerHTML = `
                                                                                    <label for="">Setor Máquina de solda <span class="required">*</span></label>
                                                                                    <select class="form-control select2_setor_maq_solda" name="setor_maq_solda" id="setor_maq_solda_${solicitacaoPk}" required>
                                                                                        <option value="">--</option>
                                                                                        <option value="laterais">Laterais</option>
                                                                                        <option value="eixos">Eixos</option>
                                                                                        <option value="icamentos">Içamentos</option>
                                                                                        <option value="plataforma">Plataforma</option>
                                                                                        <option value="chassi">Chassi</option>
                                                                                        <option value="tanque">Tanque</option>
                                                                                        <option value="cacamba">Caçamba</option>
                                                                                        <option value="serralheria">Serralheria</option>
                                                                                        <option value="fueiro">Fueiro</option>
                                                                                    </select>
                                                                                    `
                                                        divSetorMaqSolda.style.display = 'block';
                                                    }
                                                }
                                            });
                                            

                                            
                                        }
                                    }
                                });

                                
                            } else {
                                console.error('Nenhuma máquina encontrada.');
                            }
                        })
                        .catch(error => {
                            console.error('Erro ao carregar as máquinas:', error);
                        });
                });
            });
        }

        function escolherPlanoPreventiva(){
            document.querySelectorAll('[id^="tipo_manutencao_"]').forEach(selectElement => {
                selectElement.addEventListener('change', function() {
                    const tipoManutencao = this.value === 'preventiva_programada';
                    const modalId = this.id.split('_').pop(); // Obtém o identificador exclusivo do modal

                    const rowEscolhaPlano = document.querySelector(`#editarOrdemInicialModal${modalId} #rowEscolhaPlano`);
                    const escolherPlanoPreventiva = document.querySelector(`#editarOrdemInicialModal${modalId} #escolherPlanoPreventiva`);
                    const maquinaId = escolherPlanoPreventiva.getAttribute('data-id-maquina');

                    if (tipoManutencao) {
                        rowEscolhaPlano.style.display = 'block';
                        escolherPlanoPreventiva.setAttribute('required', 'required');

                        // Faz o fetch para buscar os planos preventivos da máquina
                        fetch(`/solicitacao/api/planos-preventiva/${maquinaId}`)
                            .then(response => response.json())
                            .then(planos => {
                                escolherPlanoPreventiva.innerHTML = '';  // Limpa as opções antigas
                                planos.forEach(plano => {
                                    const option = document.createElement('option');
                                    option.value = plano.id;
                                    option.textContent = plano.nome;
                                    escolherPlanoPreventiva.appendChild(option);
                                });
                            })
                            .catch(error => {
                                console.error('Erro ao buscar planos preventivos:', error);
                            });

                    } else {
                        rowEscolhaPlano.style.display = 'none';
                        escolherPlanoPreventiva.innerHTML = '';  // Limpa as opções
                        escolherPlanoPreventiva.removeAttribute('required');

                    }
                });
            });
        }

        function attachStatusReenviarWpp() {
            // Seleciona todos os links que começam com o ID "btnReenviarWpp_"
            const btnReenviar = document.querySelectorAll('a[id^="btnReenviarWpp_"]');

            btnReenviar.forEach(function (link) {
                // Extrai o ID da solicitação (pk) a partir do ID do link
                const pk = link.id.split('_')[1];  // Ajuste: posição correta do ID

                // Adiciona o evento de clique a cada link
                link.addEventListener('click', function (event) {
                    event.preventDefault();  // Evita comportamento padrão do link
                    reenviarMensagem(pk);  // Chama a função para reenviar a mensagem
                });
            });
        }

        function reenviarMensagem(ordemId) {

            var url = `{% url 'reenviar_mensagem' 0 %}`.replace('/0/', `/${ordemId}/`);

            // Exibe o modal de carregamento
            Swal.fire({
                title: 'Processando...',
                text: 'Aguarde enquanto processamos sua solicitação.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading(); // Exibe o spinner de carregamento
                }
            });
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}', // Inclua o CSRF token
                },
            })
            .then(response => {
                if (response.ok) {

                    // Mostrar o popup de sucesso
                    Swal.fire({
                        icon: 'success',
                        title: 'Sucesso',
                        text: 'Mensagem reenviada com sucesso!',
                        confirmButtonText: 'OK'
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro',
                        text: 'Ocorreu um erro ao reenviar a mensagem. Tente novamente.',
                        confirmButtonText: 'OK'
                    });
                }
            })
            .catch(error => console.error('Erro:', error));
        }

        function attachSelect2Operador() {
            // Seleciona todos os elementos <a> com o id que começa com "btnVisualizarOrdem_"
            const buttons = document.querySelectorAll('[id^="btnVisualizarOrdem_"]');

            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    // Extrai o número da chave primária (pk) do ID do botão
                    const pk = this.id.split('_')[1];
                    const selectId = `#id_operador_${pk}`;
                    const modalId = `#executarModal${pk}`;

                    // Verifica se o modal já tem o evento registrado para evitar múltiplas anexações
                    if (!$(modalId).data('select2-attached')) {
                        $(modalId).on('shown.bs.modal', function() {

                            if ($(selectId).length) {
                                // Inicializa o select2
                                $(selectId).select2({
                                    placeholder: "Selecione o operador",
                                    allowClear: true,
                                    width: '100%',
                                    dropdownParent: $('body') // Garante que o dropdown esteja contido no modal
                                });
                            } else {
                                console.log("Elemento select não encontrado:", selectId);
                            }
                        });

                        // Marca o modal como tendo o evento registrado
                        $(modalId).data('select2-attached', true);
                    }
                });
            });
        }

        function createEditModal(item, operadoresLista) {
            // Verifique se o modal já existe no DOM
            if (document.getElementById(`editModal${item.id}`)) {
                $(`#editModal${item.id}`).modal('show');
                return; // Não crie o modal novamente
            }

            // Monta o HTML do modal
            const modalHtml = `
                <div class="modal fade" id="editModal${item.id}" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="editModalLabel">Editar Execução</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="editForm${item.id}">
                                    <div class="mb-3">
                                        <label for="dataInicio${item.id}" class="form-label">Data Início</label>
                                        <input type="datetime-local" class="form-control" id="dataInicio${item.id}" name="data_inicio" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="dataFim${item.id}" class="form-label">Data Fim</label>
                                        <input type="datetime-local" class="form-control" id="dataFim${item.id}" name="data_fim" required>
                                    </div>
                                    ${item.n_execucao > 0 ? `
                                        <div class="mb-3">
                                            <label for="observacao${item.id}" class="form-label">Observação</label>
                                            <textarea class="form-control" id="observacao${item.id}" name="observacao" required></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label for="operadores${item.id}" class="form-label">Operadores</label>
                                            <select multiple="multiple" class="form-control" id="operadores${item.id}" name="operadores[]" required>
                                            </select>
                                        </div>
                                    ` : ''}
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                <button type="button" class="btn btn-primary" id="saveEdit_${item.id}">Salvar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Adiciona o modal ao body
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Popula os campos do modal com o horário local
            const dataInicioLocal = new Date(item.data_inicio);
            const dataFimLocal = item.data_fim ? new Date(item.data_fim) : null;

            const formatDateTimeLocal = (date) => {
                const pad = (n) => n.toString().padStart(2, '0');
                return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
            };

            $(`#dataInicio${item.id}`).val(formatDateTimeLocal(dataInicioLocal));
            $(`#dataFim${item.id}`).val(dataFimLocal ? formatDateTimeLocal(dataFimLocal) : '');
            $(`#observacao${item.id}`).val(item.observacao || '');

            // Preenche o select de operadores
            const operadoresSelect = $(`#operadores${item.id}`);
            operadoresLista.forEach(op => {
                const isSelected = item.operadores.includes(op.nome); // Verifica se o operador já está selecionado
                operadoresSelect.append(new Option(op.nome, op.id, isSelected, isSelected));
            });

            // Inicializa o Select2
            operadoresSelect.select2({
                placeholder: "Selecione os operadores",
                allowClear: true,
                dropdownParent: $(`#editModal${item.id}`),
                width: '100%' // Configuração correta para ajustar a largura
            });

            $(`#editModal${item.id}`).modal('show');

            // Configura o botão de salvar
            attachSaveButton(item.id);
        }
        
        function attachEditButtons() {
            const editButtons = document.querySelectorAll('[id^="btnEdit_"]');

            editButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const itemId = this.id.split('_')[1];
                    if (document.getElementById(`editModal${itemId}`)) {
                        $(`#editModal${itemId}`).modal('show');
                        return; // Não crie o modal novamente
                    }

                    // Exibe o spinner de carregamento
                    Swal.fire({
                        title: 'Processando...',
                        text: 'Buscando informações',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading(); // Exibe o spinner de carregamento
                        }
                    });

                    // Fetch para buscar os dados do item no backend
                    fetch(`/home/dados-editar/${itemId}/`)
                        .then(response => response.json())
                        .then(item => {
                            // Fecha o modal de carregamento
                            Swal.close();
                            console.log(item);
                            // Cria e exibe o modal de edição com os dados carregados
                            createEditModal(item.dados[0], item.operadores);
                        })
                        .catch(error => {
                            // Fecha o modal de carregamento em caso de erro
                            Swal.close();

                            console.error('Erro ao carregar dados para edição:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Erro',
                                text: 'Erro ao carregar dados para edição.',
                            });
                        });
                });
            });
        }

        function attachSaveButton(itemId) {
            document.getElementById(`saveEdit_${itemId}`).addEventListener('click', function() {

                const form = document.getElementById(`editForm${itemId}`);

                // Verifica se o formulário é válido
                if (!form.checkValidity()) {
                    form.reportValidity(); // Exibe mensagens de erro nos campos obrigatórios
                    return; // Interrompe o envio se houver campos inválidos
                }

                const formData = {
                    data_inicio: new Date(document.getElementById(`dataInicio${itemId}`).value).toISOString(),
                    data_fim: new Date(document.getElementById(`dataFim${itemId}`).value).toISOString(),
                    observacao: document.getElementById(`observacao${itemId}`).value,
                    operadores: $(`#operadores${itemId}`).val(),
                };

                Swal.fire({
                    title: 'Processando...',
                    text: 'Aguarde enquanto processamos a edição.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading(); // Exibe o spinner de carregamento
                    }
                });

                fetch(`/home/historico/${itemId}/editar/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: JSON.stringify(formData),
                })
                    .then(response => {
                        // if (!response.ok) throw new Error('Erro ao salvar alterações');
                        if (!response.ok){
                             // Se a resposta não for bem-sucedida, tenta obter o JSON de erro
                            return response.json().then(errData => {
                                // Verifique se a resposta contém o campo de erro
                                const errorMessage = errData.error || 'Erro desconhecido ao salvar alterações';
                                throw new Error(errorMessage); // Lança o erro com a mensagem
                            });
                        }
                        return response.json(); // Converte a resposta para JSON

                    })
                    .then(data => {
                        detalhesHistorico(data.ordem); // Atualiza os detalhes do histórico
                        $(`#editModal${itemId}`).modal('hide'); // Fecha o modal de edição
                        Swal.close(); // Fecha o carregamento, se aplicado
                    })
                    .catch(error => {
                        console.error('Erro ao salvar alterações:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Erro',
                            // text: error.responseJSON?.error || 'Ocorreu um erro ao salvar as alterações. Tente novamente mais tarde.',
                            text: error.message || 'Ocorreu um erro ao salvar as alterações. Tente novamente mais tarde.',
                            confirmButtonText: 'OK'
                        });
                    });
            });
        }

        function detalhesHistorico(pk){
            const bodyHistorico = document.getElementById(`bodyHistorico_${pk}`);
            bodyHistorico.innerHTML = `<div class="loading-overlay" id="loading-historico">
            <div class="spinner"></div>
            </div>`
            // bodyHistorico.innerHTML = ''; // Limpa o conteúdo atual

            // Envia uma solicitação fetch para buscar os dados do histórico no backend
            fetch(`/home/historico/${pk}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao buscar histórico');
                    }
                    return response.json(); // Converte a resposta em JSON
                })
                .then(data => {
                    if (data && data.historico.length > 0) {
                        bodyHistorico.innerHTML = '';
                        data.historico.forEach(item => {
                            const card = `
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <strong>Status:</strong> ${item.status}
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <p><strong>Início:</strong> ${new Date(item.data_inicio).toLocaleString('pt-BR')}</p>
                                            <p><strong>Fim:</strong> ${item.data_fim ? new Date(item.data_fim).toLocaleString('pt-BR') : 'Em andamento'}</p>
                                            <p><strong>Atualização:</strong> ${new Date(item.ultima_atualizacao).toLocaleString('pt-BR')}</p>
                                        </div>
                                        <p><strong>Observação:</strong> ${item.observacao ? item.observacao : 'N/A'}</p>
                                        <p><strong>Operadores:</strong> ${item.operadores.length > 0 ? item.operadores.join(', ') : 'Nenhum operador registrado'}</p>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn badge btn-primary" id="btnEdit_${item.id}">Editar</button>
                                    </div>
                                </div>
                            `;
                            bodyHistorico.innerHTML += card;
                        });
                        
                        // Após carregar o histórico, anexe eventos aos botões "Editar"
                        attachEditButtons();

                    } else {
                        bodyHistorico.innerHTML = '<p class="text-center">Nenhum histórico disponível para esta ordem.</p>';
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    bodyHistorico.innerHTML = '<p class="text-center text-danger">Erro ao carregar o histórico.</p>';
                });
        }

        // Função auxiliar para criar objetos Date seguros
        function parseDate(input) {
            return input ? new Date(input + 'Z') : null; // Adiciona 'Z' para forçar UTC
        }

        // function attachVerificarData() {
        //     const dataInicioElement = document.getElementById('id_data_inicio');
        //     const dataFimElement = document.getElementById('id_data_fim');

        //     // Verifique se os elementos existem antes de adicionar os event listeners
        //     if (dataInicioElement && dataFimElement) {
        //         dataFimElement.addEventListener('input', function() {
        //             console.log("Verificando datas...");

        //             const dataInicio = new Date(dataInicioElement.value);
        //             const dataFim = new Date(this.value);

        //             // Verifica se os campos de data têm valores válidos antes de fazer a comparação
        //             if (dataInicioElement.value && this.value) {
        //                 if (dataFim < dataInicio) {
        //                     alert('A data de fim deve ser maior que a data de início.');
        //                     // this.value = ''; // Limpa o campo de data_fim se a validação falhar
        //                 }
        //             }
        //         });
        //     } else {
        //         console.error("Os elementos de data de início e/ou data de fim não foram encontrados.");
        //     }
        // }

        function attachHistorico() {
            // Seleciona todos os elementos <a> com o id que começa com "btnHistorico_"
            const buttons = document.querySelectorAll('[id^="btnHistorico_"]');

            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    // Extrai o número da chave primária (pk) do ID do botão
                    const pk = this.id.split('_')[1];

                    // Elemento onde o histórico será exibido
                    const bodyHistorico = document.getElementById(`bodyHistorico_${pk}`);
                    bodyHistorico.innerHTML = `<div class="loading-overlay" id="loading-historico">
                    <div class="spinner"></div>
                    </div>`
                    // bodyHistorico.innerHTML = ''; // Limpa o conteúdo atual
                    
                    const isAdmin = document.getElementById('tipo-usuario').value;

                    // Envia uma solicitação fetch para buscar os dados do histórico no backend
                    fetch(`/home/historico/${pk}/`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Erro ao buscar histórico');
                            }
                            return response.json(); // Converte a resposta em JSON
                        })
                        .then(data => {
                            if (data && data.historico.length > 0) {
                                bodyHistorico.innerHTML = '';
                                data.historico.forEach(item => {
                                    // Cria um card para cada item do histórico

                                    const card = `
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <strong>Status:</strong> ${item.status}
                                        </div>
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <p><strong>Início:</strong> ${new Date(item.data_inicio).toLocaleString('pt-BR')}</p>
                                                <p><strong>Fim:</strong> ${item.data_fim ? new Date(item.data_fim).toLocaleString('pt-BR') : 'Em andamento'}</p>
                                                <p><strong>Atualização:</strong> ${new Date(item.ultima_atualizacao).toLocaleString('pt-BR')}</p>
                                            </div>
                                            <p><strong>Observação:</strong> ${item.observacao ? item.observacao : 'N/A'}</p>
                                            <p><strong>Operadores:</strong> ${item.operadores.length > 0 ? item.operadores.join(', ') : 'Nenhum operador registrado'}</p>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn badge btn-primary" id="btnEdit_${item.id}">Editar</button>
                                        </div>
                                    </div>
                                    `;
                                    bodyHistorico.innerHTML += card;
                                });
                                
                                // Após carregar o histórico, anexe eventos aos botões "Editar"
                                attachEditButtons();

                            } else {
                                bodyHistorico.innerHTML = '<p class="text-center">Nenhum histórico disponível para esta ordem.</p>';
                            }
                        })
                        .catch(error => {
                            console.error('Erro:', error);
                            bodyHistorico.innerHTML = '<p class="text-center text-danger">Erro ao carregar o histórico.</p>';
                        });
                });
            });
        }

        function attachMaisDetalhes() {
            // Seleciona todos os elementos <a> com o id que começa com "btnHistorico_"
            const buttons = document.querySelectorAll('[id^="btnDetalhes_"]');

            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    // Extrai o número da chave primária (pk) do ID do botão
                    const pk = this.id.split('_')[1];

                    // Elemento onde o histórico será exibido
                    const bodyDetalhes = document.getElementById(`bodyMaisDetalhes_${pk}`);
                    bodyDetalhes.innerHTML = `<div class="loading-overlay" id="loading-historico">
                    <div class="spinner"></div>
                    </div>`
                    // bodyHistorico.innerHTML = ''; // Limpa o conteúdo atual

                    // Envia uma solicitação fetch para buscar os dados do histórico no backend
                    fetch(`/home/mais-detalhes/${pk}/`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Erro ao buscar histórico');
                            }
                            return response.json(); // Converte a resposta em JSON
                        })
                        .then(data => {
                            if (data && data.solicitacoes.length > 0) {
                                bodyDetalhes.innerHTML = '';
                                data.solicitacoes.forEach(item => {

                                    bodyDetalhes.innerHTML = `
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="container">
                                                    <div class="row">
                                                        <div class="col-md-6 mb-2">
                                                            <strong>Solicitante:</strong> ${item.nome_solicitante || 'N/A'}
                                                        </div>
                                                        <div class="col-md-6 mb-2">
                                                            <strong>Setor:</strong> ${item.setor_nome || 'N/A'}
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6 mb-2">
                                                            <strong>Equipamento:</strong> ${item.nome_maquina || 'N/A'}
                                                        </div>
                                                        <div class="col-md-6 mb-2">
                                                            <strong>Operador Responsável:</strong> ${item.operador_responsavel || 'N/A'}
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6 mb-2">
                                                            <strong>Impacto na Produção:</strong> ${item.impacto_producao || 'N/A'}
                                                        </div>
                                                        <div class="col-md-6 mb-2">
                                                            <strong>Status de Andamento:</strong> ${item.status_andamento || 'N/A'}
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6 mb-2">
                                                            <strong>Data de Abertura:</strong> ${new Date(item.data_abertura).toLocaleString('pt-BR') || 'N/A'}
                                                        </div>
                                                        <div class="col-md-6 mb-2">
                                                            <strong>Programação:</strong> ${
                                                                (() => {
                                                                    const date = new Date(item.programacao);
                                                                    date.setDate(date.getDate() + 1); // Adiciona 1 dia
                                                                    return date.toLocaleDateString('pt-BR') || 'N/A';
                                                                })()
                                                            }                                                        
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-12">
                                                            <strong>Motivo:</strong> ${item.descricao || 'N/A'}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                });
                            } else {
                                bodyDetalhes.innerHTML = '<p class="text-center">Detalhes não disponível para esta ordem.</p>';
                            }
                        })
                        .catch(error => {
                            console.error('Erro:', error);
                            bodyDetalhes.innerHTML = '<p class="text-center text-danger">Erro ao carregar o histórico.</p>';
                        });
                });
            });
        }


        Promise.all([
            
            // Verifica se o elemento existe antes de adicionar a função ao array de Promises
            // document.getElementById('headingAguardandoPrimeiroAtendimento') 
            //     ? loadSection("aguardando-primeiro-atendimento/", "aguardando-primeiro-atendimento-container", [attachExecutar1OrdemEventListeners, attachStatusChangeListeners, escolherPlanoPreventiva])
            //     : Promise.resolve(),  // Garante que o array de Promises sempre receba um valor

            document.getElementById('headingMaquinasParadas') 
                ? loadSection("maquinas-paradas/", "maquinas-paradas-container")
                : Promise.resolve(),  // Garante que o array de Promises sempre receba um valor
                
            // loadSection("solicitacoes/", "solicitacoes-container", [attachExecutarOrdemEventListeners, mudancaStatusFinalizada, attachStatusReenviarWpp]),
            
            fetchSolicitacoes("solicitacoes/", "solicitacoes-container", "loadMoreSolicitacoes", params='', [
                attachReprogramarOrdemEventListeners,
                attachExecutarOrdemEventListeners,
                mudancaStatusFinalizada,
                attachStatusReenviarWpp,
                attachModalEventListeners,
                attachSelect2Operador,
                // attachVerificarData,
                attachHistorico,
                attachMaisDetalhes,
            ]),

            document.getElementById('headingAguardandoPrimeiroAtendimento') 
                ? fetchSolicitacoes(
                    "aguardando-primeiro-atendimento/",                  // URL base
                    "aguardando-primeiro-atendimento-container",         // ID do container onde os dados serão inseridos
                    "loadMoreAguardandoPrimeiroAtendimento",           // ID do botão de 'load more'
                    params,                           // Parâmetros do filtro
                    [attachExecutar1OrdemEventListeners,
                     attachStatusChangeListeners,
                     escolherPlanoPreventiva,
                     attachModalEventListeners
                    ] // Callback após carregar as solicitações
                )
                : Promise.resolve(),  // Garante que o array de Promises sempre receba um valor

        ]).then(() => {

        }).catch(error => {
            console.error("Erro ao carregar as seções:", error);
        });
    });
</script>

<script>
    function toggleMaqParada(solicitacaoId) {
        //Verica se a máquina já está parada


        let checkboxParada = document.getElementById(`maqParadaToggle${solicitacaoId}`);
        const isChecked = checkboxParada.checked;

        //Desabilita o botão de salvar ao trocar o toggle de Maquina Parada
        const salvarButton = document.getElementById(`salvarPrimeiraExecucao_${solicitacaoId}`);
        salvarButton.disabled = true;

        const textoMaquinaParada = document.getElementById(`returnTextMaquinaParada${solicitacaoId}`);

        const modalEditarOrdem = document.getElementById(`editarOrdemInicialModal${solicitacaoId}`)

        if (modalEditarOrdem.querySelector('.input-eq-falha')){
            const tipoEqEmFalha = modalEditarOrdem.querySelector('.input-eq-falha').value;
            if (tipoEqEmFalha === 'Ferramentas'){
                textoMaquinaParada.style.display = "none";
                salvarButton.disabled = false;
                return;
            }
        }else if (document.getElementById(`eq_falha_${solicitacaoId}`)){
            const tipoEqEmFalha = document.getElementById(`eq_falha_${solicitacaoId}`).value;
            if (tipoEqEmFalha === 'ferramentas'){
                textoMaquinaParada.style.display = "none";
                salvarButton.disabled = false;
                return;
            }
        }
        // Envia uma requisição AJAX para atualizar o status da máquina
        fetch("{% url 'atualizar_status_maq_parada' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}', // Inclua o CSRF token
            },
            body: JSON.stringify({
                'solicitacao_id': solicitacaoId,
                'maq_parada': isChecked
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // alert('Status da máquina atualizado com sucesso!');
                if (data.parada){
                    // alert('A máquina já está parada segundo outra ordem!');
                    
                    textoMaquinaParada.style.display = "block";
                    checkboxParada.checked = false;
                    salvarButton.disabled = false;
                }else{
                    console.log('Máquina funcionando');
                    textoMaquinaParada.style.display = "none";
                    salvarButton.disabled = false;
                }
            } else {
                alert('Erro ao atualizar o status da máquina.');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao atualizar o status da máquina.');
        });
    }

    function verificaOrdensDia(input){
        const idOrdem = input.id.split('_')[2];
        var ordensDia = document.getElementById(`quantidade_ordens_dia${idOrdem}`);
        let data_prog = input.value;

        if (!ordensDia){
            ordensDia = document.getElementById(`quantidade_ordens_dia_${idOrdem}`);
        }

        ordensDia.textContent = "Carregando..."

        // Usando fetch para obter dados de uma URL
        fetch(`/programacao/ordens-programadas/producao/?data_prog=${data_prog}`)
        .then(response => {
            // Verificando se a resposta foi bem-sucedida (status 200)
            if (!response.ok) {
                throw new Error('Erro ao buscar os dados');
            }
            return response.json(); // Converte a resposta para formato JSON
        })
        .then(data => {
            // console.log('Dados recebidos:', data); // Exibe os dados no console
            if (data.countData == 0){
                ordensDia.textContent =`Não existem ordens programadas para este dia!`;
            }else{
                ordensDia.textContent =`Existem ${data.countData} ordens já programadas para este dia!`;
            }
        })
        .catch(error => {
            console.error('Erro:', error); // Lida com erros, caso ocorra algum
        });

    }

    function validaDataProg(input){
        
        const idOrdem = input.id.split('_')[2];
        var dataAberturaInput = document.getElementById(`id_data_abertura_${idOrdem}`);
        const saveReprogramarButton = document.getElementById(`saveReprogramarSolicitacaoButton_${idOrdem}`);
        const erroMensagemDataProg = document.getElementById(`erroMensagemDataProg_${idOrdem}`);

        let data_prog = input.value;
        let data_abertura = dataAberturaInput.value.split('T')[0];
        let data_atual = new Date().toISOString().split('T')[0];
        // console.log(data_atual);


        if(data_prog < data_abertura){
            saveReprogramarButton.disabled = true;
            erroMensagemDataProg.textContent = 'A Data de Programação não pode ser menor que a Data de Abertura.'
            erroMensagemDataProg.style.visibility = 'visible';
        }else if(data_prog < data_atual){
            saveReprogramarButton.disabled = true;
            erroMensagemDataProg.textContent = 'A Data de Programação não pode ser menor que a Data Atual.';
            erroMensagemDataProg.style.visibility = 'visible';
        }else{
            erroMensagemDataProg.style.visibility = 'hidden';
            saveReprogramarButton.disabled = false;
        }
    }
    // Função a ser chamada ao abrir o modal (com Bootstrap)
    let modalIdClose;
    function verificarMaquinaParadaExecucao(button) {
        let solicitacaoId = button.id.split("_")[1];
        const modalId = button.getAttribute('data-bs-target');
        let maquinaParadaText = document.getElementById(`maquina_parada_text${solicitacaoId}`);

        const modal = document.getElementById(`executarModal${solicitacaoId}`);

        modalIdClose = modalId;


        $(modalId).on('shown.bs.modal',function(){

            fetch("{% url 'atualizar_status_maq_parada' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}', // Inclua o CSRF token
            },
            body: JSON.stringify({
                'solicitacao_id': solicitacaoId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // alert('Status da máquina atualizado com sucesso!');
                if (data.parada){
                    // alert('A máquina já está parada segundo outra ordem!');
                    console.log('Máquina parada');
                    // textoMaquinaParada.style.display = "block";
                    // checkboxParada.checked = false;
                    // salvarButton.disabled = false;
                    // id_che_maq_parada_sim
                    // id_exec_maq_parada_sim
                    // id_apos_exec_maq_parada_sim
                    maquinaParadaText.style.display = 'block';
                    modal.querySelectorAll('.yes-check').forEach(element =>{
                        element.disabled = true;
                    })
                    modal.querySelectorAll('.no-check').forEach(element =>{
                        element.checked = true;
                    })
                }else{
                    console.log('Máquina funcionando');
                    // textoMaquinaParada.style.display = "none";
                    // salvarButton.disabled = false;
                    maquinaParadaText.style.display = 'none';
                    modal.querySelectorAll('.yes-check').forEach(element =>{
                        element.disabled = false;
                    })
                    modal.querySelectorAll('.no-check').forEach(element =>{
                        element.checked = false;
                    })
                }
            } else {
                alert('Erro ao atualizar o status da máquina.');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao atualizar o status da máquina.');
        });

        })
    // Aqui você pode adicionar outras ações
    }
        
    function atualizarSelectMaquina(select,tipoEquipamento){
        // event.preventDefault();
        const solicitacaoPk = select.id.split('_')[2]; // Obtém o ID da solicitação
        // const selectMaquina = document.getElementById(`id_maquina_${solicitacaoPk}`);
        const divMaquina = document.getElementById(`editarMaquina_${solicitacaoPk}`);
        
        // Remove o campo de texto e adiciona um <select> no lugar
            divMaquina.innerHTML = `
            <select class="form-control select2_maquina" name="id_maquina" id="id_maquina_${solicitacaoPk}" required>
                <option value="">Carregando máquinas...</option>
            </select>
        `;
        
        var setor;
        // Verifica o valor do campo Setor
        if ($(`#id_setor_${solicitacaoPk}`).val()){
            setor = $(`#id_setor_${solicitacaoPk}`).val();
        }else{
            //Setor de Solda
            setor = 3;
        }
        
        // Faz a requisição AJAX para carregar as máquinas
        // fetch(`/solicitacao/ajax/get-maquinas/?setor=${setor}&area=producao`)
        if (tipoEquipamento == ''){
            fetch(`/solicitacao/ajax/get-all-maquinas/${setor}`)
            .then(response => response.json())
            .then(data => {
                if (data.results) {
                    updateSelectElement(`id_maquina_${solicitacaoPk}`, data.results, function(optionData) {
                        return optionData.text;  // Exibe o nome da máquina
                        // return optionData.fields.codigo + ' - ' + optionData.fields.descricao;
                    });

                    // Inicializa o Select2 após adicionar as opções
                    $(`#id_maquina_${solicitacaoPk}`).select2({
                        placeholder: "Selecione a máquina",
                        allowClear: true,
                        width: '100%',
                        dropdownParent: $(`#editarMaquina_${solicitacaoPk}`), // Garante que o dropdown esteja contido no modal
                        language: {
                            noResults: function() {
                                return "Nenhuma máquina foi encontrada nesse setor !";
                        }}
                    });
                } else {
                    console.error('Nenhuma máquina encontrada.');
                    divMaquina.innerHTML = `
                        <select class="form-control select2_maquina" name="id_maquina" id="id_maquina_${solicitacaoPk}" required>
                            <option value="">Nenhuma máquina encontrada</option>
                        </select>
                    `;
                }
            })
            .catch(error => {
                console.error('Erro ao carregar as máquinas:', error);
            });
        }else{
            var url = '{% url "get_maquina_by_eq_em_falha" %}?setor=' + encodeURIComponent(setor) + '&tipo=' + encodeURIComponent(tipoEquipamento);
            fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.maquinas) {
                        updateSelectElement2(`id_maquina_${solicitacaoPk}`, JSON.parse(data.maquinas), function(optionData) {
                            return optionData.fields.codigo + ' - ' + optionData.fields.descricao;
                        });

                    // Inicializa o Select2 após adicionar as opções
                    $(`#id_maquina_${solicitacaoPk}`).select2({
                        placeholder: "Selecione a máquina",
                        allowClear: true,
                        width: '100%',
                        dropdownParent: $(`#editarMaquina_${solicitacaoPk}`) // Garante que o dropdown esteja contido no modal
                    });
                } else {
                    console.error('Nenhuma máquina encontrada.');
                    divMaquina.innerHTML = `
                        <select class="form-control select2_maquina" name="id_maquina" id="id_maquina_${solicitacaoPk}" disabled>
                            <option value="">Nenhuma máquina encontrada</option>
                        </select>
                    `;
                }
            })
            .catch(error => {
                console.error('Erro ao carregar as máquinas:', error);
            });

        }
        
    }

    function checkMaquinaParada(solicitacaoId,selectMaquina) {
        //Verica se a máquina já está parada
        let codMaquina;
        if (document.getElementById(selectMaquina)){
            codMaquina = document.getElementById(selectMaquina).value;
            
        }else{
            codMaquina = selectMaquina.value;
        }
        
        let checkboxParada = document.getElementById(`maqParadaToggle${solicitacaoId}`);
        const isChecked = checkboxParada.checked;

        //Desabilita o botão de salvar ao trocar o toggle de Maquina Parada
        const salvarButton = document.getElementById(`salvarPrimeiraExecucao_${solicitacaoId}`);
        salvarButton.disabled = true;

        const textoMaquinaParada = document.getElementById(`returnTextMaquinaParada${solicitacaoId}`);

        const modalEditarOrdem = document.getElementById(`editarOrdemInicialModal${solicitacaoId}`);

        if (document.getElementById(`eq_falha_${solicitacaoId}`)){
            const tipoEqEmFalha = document.getElementById(`eq_falha_${solicitacaoId}`).value;
            if (tipoEqEmFalha === 'ferramentas'){
                textoMaquinaParada.style.display = "none";
                salvarButton.disabled = false;
                return;
            }
        }else if (modalEditarOrdem.querySelector('.input-eq-falha')){
            const tipoEqEmFalha = modalEditarOrdem.querySelector('.input-eq-falha').value;
            if (tipoEqEmFalha === 'Ferramentas'){
                textoMaquinaParada.style.display = "none";
                salvarButton.disabled = false;
                return;
            }
        }
        
        
        // Envia uma requisição AJAX para atualizar o status da máquina
        fetch("{% url 'atualizar_status_maq_parada' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}', // Inclua o CSRF token
            },
            body: JSON.stringify({
                'solicitacao_id': solicitacaoId,
                'maq_parada': isChecked,
                'cod_maquina' : codMaquina,
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // alert('Status da máquina atualizado com sucesso!');
                if (data.parada){
                    // alert('A máquina já está parada segundo outra ordem!');
                    
                    textoMaquinaParada.style.display = "block";
                    checkboxParada.checked = false;
                    salvarButton.disabled = false;
                }else{
                    console.log('Máquina funcionando');
                    textoMaquinaParada.style.display = "none";
                    salvarButton.disabled = false;
                }
            } else {
                alert('Erro ao atualizar o status da máquina.');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao atualizar o status da máquina.');
        });
    }
</script>

{% endblock %}
