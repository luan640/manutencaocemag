{% extends 'base.html' %}

{% block title %}
Manutenções Semanais
{% endblock %}

{% block links %}
<style>
    .header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background-color: #0284c7;
        color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .header-container h2 {
        margin: 0;
        font-size: 20px;
        font-weight: bold;
    }

    .header-right {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .filtro-maquina {
        padding: 6px 10px;
        border-radius: 4px;
        border: 1px solid #ddd;
        font-size: 14px;
        min-width: 220px;
    }

    .btn-voltar {
        background-color: #f44336;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        font-size: 14px;
        transition: 0.3s;
    }

    .btn-voltar:hover {
        background-color: #d32f2f;
    }

    .semanas-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
        padding: 20px;
    }

    .semana-card {
        width: 220px;
        min-height: 180px;
        background: #f5f5f5;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 10px;
        text-align: center;
        transition: 0.3s;
    }

    .semana-card:hover {
        transform: scale(1.05);
    }

    .semana-atual {
        border: 3px solid #ff9800;
        box-shadow: 0 0 10px rgba(255, 152, 0, 0.6);
    }

    .semana-card h3 {
        margin: 0;
        padding: 8px;
        font-size: 16px;
        background: #ddd;
        border-radius: 5px;
    }

    .manutencoes {
        margin-top: 8px;
        text-align: left;
        font-size: 14px;
        padding: 5px;
    }

    .btn-detalhes {
        margin-top: 6px;
        background-color: #0284c7;
        color: #fff;
        border: none;
        border-radius: 4px;
        padding: 6px 8px;
        font-size: 12px;
        cursor: pointer;
        transition: 0.2s;
    }

    .btn-detalhes:hover {
        background-color: #0369a1;
    }

    .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .modal-backdrop.hidden {
        display: none;
    }

    .modal-content {
        width: 90%;
        max-width: 520px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
    }

    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: #f1f5f9;
        border-bottom: 1px solid #e2e8f0;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 16px;
    }

    .modal-close {
        background: transparent;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: #475569;
    }

    .modal-body {
        padding: 16px;
        font-size: 14px;
    }

    .modal-row {
        display: flex;
        gap: 8px;
        padding: 4px 0;
        border-bottom: 1px dashed #e2e8f0;
    }

    .modal-row:last-child {
        border-bottom: none;
    }

    .modal-label {
        min-width: 140px;
        font-weight: 600;
        color: #334155;
    }

    .modal-value {
        color: #0f172a;
        word-break: break-word;
    }

    .janeiro { background-color: #f0f8ff; }
    .fevereiro { background-color: #faebd7; }
    .marco { background-color: #ffe4e1; }
    .abril { background-color: #f5f5dc; }
    .maio { background-color: #f0fff0; }
    .junho { background-color: #e6e6fa; }
    .julho { background-color: #fffacd; }
    .agosto { background-color: #fdf5e6; }
    .setembro { background-color: #fafad2; }
    .outubro { background-color: #ffe4b5; }
    .novembro { background-color: #ffdab9; }
    .dezembro { background-color: #e0ffff; }
</style>
{% endblock %}

{% block content %}

<div class="header-container">
    <h2 id="semana-atual-info">Semana Atual: Carregando...</h2>
    <div class="header-right">
        <label for="filtro-maquina">Buscar máquina:</label>
        <input
            id="filtro-maquina"
            class="filtro-maquina"
            type="text"
            placeholder="Digite o nome da máquina"
            list="lista-maquinas" autocomplete="off"/>
        <datalist id="lista-maquinas"></datalist>
        <a href="/preventiva/" class="btn-voltar">Voltar para Preventivas</a>
    </div>
</div>

<div id="semanas-container" class="semanas-container"></div>

<div id="modal-detalhes" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modal-detalhes-titulo">
        <div class="modal-header">
            <h3 id="modal-detalhes-titulo">Detalhes da OS</h3>
            <button type="button" class="modal-close" aria-label="Fechar">X</button>
        </div>
        <div class="modal-body" id="modal-detalhes-body"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    fetch('/manutencoes-semana/')
        .then(response => response.json())
        .then(data => {
            const weeks = [];
            const maquinasSet = new Set();

            if (Array.isArray(data)) {
                data.forEach(plan => {
                    if (!plan || !Array.isArray(plan.semanas)) {
                        return;
                    }

                    plan.semanas.forEach(week => {
                        const idx = (week.semana || 0) - 1;
                        if (idx < 0) {
                            return;
                        }

                        if (!weeks[idx]) {
                            weeks[idx] = {
                                semana: week.semana,
                                inicio: week.inicio,
                                fim: week.fim,
                                manutencoes: []
                            };
                        }

                        if (Array.isArray(week.manutencoes)) {
                            week.manutencoes.forEach(ev => {
                                weeks[idx].manutencoes.push({
                                    maquina: ev.maquina,
                                    plano: ev.plano,
                                    data: ev.data,
                                    status_manutencao: ev.status_manutencao,
                                    status_aprovacao: ev.status_aprovacao,
                                    numero_ordem: ev.ordem,
                                    comentario_manutencao: ev.comentario_manutencao
                                });

                                if (ev.maquina) {
                                    maquinasSet.add(ev.maquina);
                                }
                            });
                        }
                    });
                });
            }

            const weeksNormalizadas = weeks.filter(Boolean);
            const semanaAtual = getSemanaAtual();
            const nomesMaquinas = Array.from(maquinasSet).sort();

            inicializarBuscaMaquinas(weeksNormalizadas, semanaAtual, nomesMaquinas);
        })
        .catch(error => {
            console.error('Erro ao carregar os dados:', error);
        });

    function inicializarBuscaMaquinas(weeks, semanaAtual, nomesMaquinas) {
        const input = document.getElementById('filtro-maquina');
        const datalist = document.getElementById('lista-maquinas');

        if (!input) {
            renderSemanas(weeks, semanaAtual, '');
            return;
        }

        if (datalist) {
            datalist.innerHTML = '';
            nomesMaquinas.forEach(nome => {
                const option = document.createElement('option');
                option.value = nome;
                datalist.appendChild(option);
            });
        }

        input.addEventListener('input', function () {
            const termo = (this.value || '').toLowerCase();
            renderSemanas(weeks, semanaAtual, termo);
        });

        // Ao focar (clicar), mantém todas as máquinas visíveis;
        // o filtro só entra em ação quando o usuário digita.
        renderSemanas(weeks, semanaAtual, '');
    }

    function renderSemanas(weeks, semanaAtual, filtroNome) {
        const container = document.getElementById('semanas-container');
        container.innerHTML = '';

        weeks.forEach(week => {
            const semanaCard = document.createElement('div');
            semanaCard.classList.add('semana-card');

            const mesClasse = getMesClasse(week.inicio);
            if (mesClasse) {
                semanaCard.classList.add(mesClasse);
            }

            if (week.inicio === semanaAtual) {
                semanaCard.classList.add('semana-atual');
            }

            const titulo = document.createElement('h3');
            titulo.textContent = 'Semana ' + week.semana;
            semanaCard.appendChild(titulo);

            const manutencoesDiv = document.createElement('div');
            manutencoesDiv.classList.add('manutencoes');

            const listaManutencoes = filtroNome
                ? week.manutencoes.filter(m =>
                    (m.maquina || '').toLowerCase().includes(filtroNome)
                  )
                : week.manutencoes;

            if (!listaManutencoes || listaManutencoes.length === 0) {
                manutencoesDiv.innerHTML = '<em>Sem manutencoes</em>';
            } else {
                listaManutencoes.forEach(manutencao => {
                    const manutencaoItem = document.createElement('div');

                    const statusFormatado = formatarStatus(
                        manutencao.status_manutencao,
                        manutencao.status_aprovacao
                    );

                    manutencaoItem.innerHTML =
                        '<strong>' + (manutencao.maquina || '') + '</strong> - ' + (manutencao.plano || '') +
                        '<br><small>' + (manutencao.data || '') + '</small>' +
                        '<br><small>' + statusFormatado + '</small>' +
                        (manutencao.numero_ordem ? '<br><small>Ordem: ' + manutencao.numero_ordem + '</small>' : '');

                    const detalhesBtn = document.createElement('button');
                    detalhesBtn.type = 'button';
                    detalhesBtn.className = 'btn-detalhes';
                    detalhesBtn.textContent = 'Detalhes';
                    detalhesBtn.addEventListener('click', function () {
                        abrirModalDetalhes(manutencao, statusFormatado);
                    });
                    manutencaoItem.appendChild(detalhesBtn);

                    if (manutencao.status_aprovacao === 'rejeitar') {
                        manutencaoItem.style.borderLeft = '4px solid #9C27B0';
                        manutencaoItem.style.backgroundColor = '#f3e5f5';
                    } else if (manutencao.status_manutencao === 'finalizada') {
                        manutencaoItem.style.borderLeft = '4px solid #4CAF50';
                        manutencaoItem.style.backgroundColor = '#f1f8e9';
                    } else if (manutencao.status_manutencao === 'em_espera') {
                        manutencaoItem.style.borderLeft = '4px solid #FF9800';
                        manutencaoItem.style.backgroundColor = '#fff3e0';
                    } else if (manutencao.status_manutencao === 'aguardando_atendimento') {
                        manutencaoItem.style.borderLeft = '4px solid #6b7280';
                        manutencaoItem.style.backgroundColor = '#f3f4f6';
                    } else if (manutencao.status_manutencao === 'nao_encontrada' || manutencao.status_manutencao === 'não encontrada') {
                        manutencaoItem.style.borderLeft = '4px solid #f44336';
                        manutencaoItem.style.backgroundColor = '#ffebee';
                    }

                    manutencaoItem.style.padding = '8px';
                    manutencaoItem.style.margin = '4px 0';
                    manutencaoItem.style.borderRadius = '4px';

                    manutencoesDiv.appendChild(manutencaoItem);
                });
            }

            semanaCard.appendChild(manutencoesDiv);
            container.appendChild(semanaCard);
        });

        const headerInfo = document.getElementById('semana-atual-info');
        if (headerInfo) {
            headerInfo.textContent = 'Semana Atual: ' + getSemanaAtualNumero();
        }
    }

    function formatarStatus(statusManutencao, statusAprovacao) {
        if (statusAprovacao === 'rejeitar') {
            return 'Rejeitada';
        }

        switch (statusManutencao) {
            case 'finalizada':
                return 'Finalizada';
            case 'em_espera':
                return 'Em espera';
            case 'aguardando_atendimento':
                return 'Aguardando Atendimento';
            case 'nao_encontrada':
            case 'não encontrada':
                return 'Não encontrada';
            default:
                return statusManutencao || 'Status indefinido';
        }
    }

    function getMesClasse(dataString) {
        if (!dataString) return '';

        const meses = [
            'janeiro', 'fevereiro', 'marco', 'abril',
            'maio', 'junho', 'julho', 'agosto',
            'setembro', 'outubro', 'novembro', 'dezembro'
        ];

        const data = new Date(dataString);
        if (Number.isNaN(data.getTime())) return '';

        const mesIndex = data.getMonth();
        return meses[mesIndex] || '';
    }

    function getSemanaAtual() {
        const hoje = new Date();
        const diaDaSemana = hoje.getDay();
        const diffSegunda = hoje.getDate() - (diaDaSemana === 0 ? 6 : diaDaSemana - 1);
        const segundaFeira = new Date(hoje);
        segundaFeira.setDate(diffSegunda);
        return segundaFeira.toISOString().split('T')[0];
    }

    function getSemanaAtualNumero() {
        const hoje = new Date();
        const d = new Date(Date.UTC(hoje.getFullYear(), hoje.getMonth(), hoje.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        const weekNo = Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
        return weekNo;
    }

    function abrirModalDetalhes(manutencao, statusFormatado) {
        const modal = document.getElementById('modal-detalhes');
        const modalBody = document.getElementById('modal-detalhes-body');
        if (!modal || !modalBody) return;

        modalBody.innerHTML = '';
        adicionarLinha(modalBody, 'Maquina', manutencao.maquina || '-');
        adicionarLinha(modalBody, 'Plano', manutencao.plano || '-');
        adicionarLinha(modalBody, 'Data prevista', manutencao.data || '-');
        adicionarLinha(modalBody, 'Status', statusFormatado || '-');
        adicionarLinha(modalBody, 'Aprovacao', formatarAprovacao(manutencao.status_aprovacao));
        adicionarLinha(modalBody, 'Ordem', manutencao.numero_ordem ? String(manutencao.numero_ordem) : '-');
        adicionarLinha(modalBody, 'Comentario', manutencao.comentario_manutencao || '-');

        modal.classList.remove('hidden');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
    }

    function adicionarLinha(container, label, value) {
        const row = document.createElement('div');
        row.className = 'modal-row';

        const labelEl = document.createElement('span');
        labelEl.className = 'modal-label';
        labelEl.textContent = label + ':';

        const valueEl = document.createElement('span');
        valueEl.className = 'modal-value';
        valueEl.textContent = value;

        row.appendChild(labelEl);
        row.appendChild(valueEl);
        container.appendChild(row);
    }

    function formatarAprovacao(statusAprovacao) {
        if (!statusAprovacao) return '-';
        if (statusAprovacao === 'rejeitar') return 'Rejeitada';
        return statusAprovacao;
    }

    function fecharModalDetalhes() {
        const modal = document.getElementById('modal-detalhes');
        if (!modal) return;
        modal.classList.add('hidden');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
    }

    const modal = document.getElementById('modal-detalhes');
    if (modal) {
        const closeBtn = modal.querySelector('.modal-close');
        if (closeBtn) {
            closeBtn.addEventListener('click', fecharModalDetalhes);
        }

        modal.addEventListener('click', function (event) {
            if (event.target === modal) {
                fecharModalDetalhes();
            }
        });
    }

    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            fecharModalDetalhes();
        }
    });
});
</script>

{% endblock %}

