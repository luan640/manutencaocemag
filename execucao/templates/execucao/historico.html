{% extends 'base.html' %}

{% load static %}

{% block links %}

<link rel="stylesheet" href="https://cdn.datatables.net/searchpanes/2.1.1/css/searchPanes.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
    /* Tabela */
    #execucaoTable {
        font-size: 12px;
    }

    #execucaoTable th, #execucaoTable td {
        padding: 4px 8px;
    }

    /* Dropdown de colunas */
    #columnToggleMenu .form-check {
        margin-bottom: 6px;
    }

    #columnToggleMenu label {
        font-size: 0.9rem;
        cursor: pointer;
    }

    /* Botões */
    .btn-toolbar .btn {
        font-size: 0.9rem;
    }

    .dropdown-menu.shadow {
        border-radius: 8px;
    }

    .btn-outline-secondary,
    .btn-outline-danger {
        border-radius: 6px;
    }

    /* Layout responsivo para mobile */
    @media (max-width: 576px) {
        .btn-toolbar {
            width: 100%;
            justify-content: flex-start;
            margin-top: 0.5rem;
        }
    }
</style>

{% endblock %}

{% block content %}

<div class="container-fluid px-3">

    <!-- Cabeçalho e botões -->
    <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
        <h2 class="mb-0">Histórico de Execuções</h2>

        <div class="btn-toolbar mt-2 mt-sm-0">
            <div class="btn-group me-2">
                <button id="btnColumnToggle"
                        class="btn btn-outline-secondary dropdown-toggle"
                        data-bs-toggle="dropdown"
                        aria-expanded="false">
                    <i class="bi bi-layout-three-columns"></i> Colunas
                </button>
                <div id="columnToggleMenu"
                    class="dropdown-menu dropdown-menu-end p-3 shadow"
                    style="max-height: 300px; overflow:auto; min-width: 220px;">
                    <!-- Checkboxes das colunas via JS -->
                     <button type="button" id="btnSelectAllColumns" class="btn btn-sm btn-outline-primary mb-2 w-100">
                        Selecionar Todos
                    </button>
                </div>
            </div>

            <button id="btnLimparFiltro"
                    type="button"
                    class="btn btn-outline-danger">
                <i class="bi bi-eraser"></i> Limpar Filtros
            </button>
        </div>
    </div>

    <!-- Botão que abre/fecha filtros -->
    <div class="mb-3">
        <!-- Botão que abre o dropdown de filtros -->
        <div class="btn-group">
            <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                Filtros
            </button>
            <div class="dropdown-menu p-3" style="width: 400px;">
                <div class="mb-2">
                    <label for="filterOrdem" class="form-label">#OS</label>
                    <input type="number" class="form-control" id="filterOrdem" placeholder="Número da ordem">
                </div>
                <div class="mb-2">
                    <label for="filterSolicitante" class="form-label">Solicitante</label>
                    <input type="text" class="form-control" id="filterSolicitante" placeholder="Nome do solicitante">
                </div>
                <div class="mb-2">
                    <label for="setor" class="form-label">Setor</label>
                    <select class="form-select" id="setor">
                        <option value="">Todos</option>
                        {% for setor in setores %}
                            <option value="{{ setor.id }}">{{ setor.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-2">
                    <label for="ultimo_status" class="form-label">Status</label>
                    <select class="form-select" id="ultimo_status" multiple>
                        <option value="">Todos</option>
                        {% for status in status_choices %}
                            <option value="{{ status.0 }}">{{ status.1 }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="text-end mt-2">
                    <button id="btnLimparFiltro" class="btn btn-secondary btn-sm">Limpar Filtros</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Tabela -->
    <div class="table-responsive">
        <table id="execucaoTable" class="table table-bordered table-striped table-sm">
            <thead>
                <tr>
                    <th>OS</th>
                    <th>Execução</th>
                    <th>Setor</th>
                    <th>Solicitante</th>
                    <th>Máquina</th>
                    <th>Comentário da manutenção</th>
                    <th>Motivo</th>
                    <th>Data de abertura</th>
                    <th>Data de início</th>
                    <th>Data de fim</th>
                    <th>Obs do executante</th>
                    <th>Status</th>
                    <th>Tipo da manutenção</th>
                    <th>Área da manutenção</th>
                    <th>Última atualização</th>
                    <th>Horas executadas</th>
                </tr>
            </thead>
            <tbody>
                <!-- Conteúdo carregado via JS -->
            </tbody>
        </table>
    </div>

</div>

{% endblock %}

{% block scripts %}

<script src="{% static 'js/datatable-historico-execucao.js' %}"></script>
<script src="https://cdn.datatables.net/searchpanes/2.1.1/js/dataTables.searchPanes.min.js"></script>

{% endblock %}
